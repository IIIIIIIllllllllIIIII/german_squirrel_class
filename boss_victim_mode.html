<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Boss & Victim: Nominativ & Akkusativ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #4f46e5, #6366f1, #7c3aed, #a78bfa, #c4b5fd); /* Indigo/Violet Gradient */
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            margin: 0;
            padding: 16px; 
            color: #f5f3ff; /* Lightest violet for text on dark bg */
            overflow-x: auto;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 24px; 
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 850px; 
            margin-top: 2vh;
            margin-bottom: 2vh;
        }
        @media (min-width: 768px) { .card { padding: 32px; } }

        .mode-title { font-size: 1.7rem; sm:font-size: 2rem; font-weight: 700; color: #ddd6fe; margin-bottom: 4px; } 
        .mode-title-subtitle { font-size: 1rem; sm:font-size: 1.1rem; color: #c4b5fd; margin-bottom: 24px; }

        .intro-toggle-button {
            background-color: rgba(255,255,255,0.15); color: #ede9fe;
            border: 1px solid #ddd6fe; padding: 0.6rem 1.2rem; border-radius: 0.5rem;
            cursor: pointer; transition: background-color 0.3s; margin-bottom: 1.5rem; font-weight: 500;
        }
        .intro-toggle-button:hover { background-color: rgba(255,255,255,0.25); }
        
        #introduction-panel {
            background-color: rgba(30, 20, 60, 0.4); 
            padding: 1.5rem; border-radius: 0.75rem; margin-top: 1rem; margin-bottom: 2rem;
            text-align: left; color: #ede9fe; 
            border: 1px solid rgba(255,255,255,0.25);
            max-height: 70vh; overflow-y: auto; 
        }
        #introduction-panel h3 { font-size: 1.5rem; font-weight: 700; color: #f0abfc; margin-top: 1.8rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #c084fc; }
        #introduction-panel h4 { font-size: 1.2rem; font-weight: 600; color: #e9d5ff; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        #introduction-panel h3:first-child { margin-top: 0;}
        #introduction-panel p, #introduction-panel li { font-size: 1rem; line-height: 1.7; margin-bottom: 1rem; color: #ede9fe;}
        #introduction-panel ul { list-style-type: 'üëâ'; padding-left: 1.8rem; margin-bottom:1.2rem; }
        #introduction-panel strong { color: #f5d0fe; font-weight: 600; }
        #introduction-panel .eselsbruecke, #introduction-panel .golden-rule { 
            background-color: rgba(255,255,255,0.1); 
            padding: 1rem; border-radius: 0.5rem; 
            margin: 1rem 0; font-style: italic; 
            border-left: 5px solid #f0abfc;
            color: #f5f3ff; font-size: 0.95rem;
        }
        #introduction-panel .golden-rule strong {color: #facc15;} /* Gold for golden rules */
        #introduction-panel .example-sentence { margin-left: 1rem; font-style: italic; color: #d8b4fe; margin-bottom: 0.35rem;}
        #introduction-panel .example-sentence strong { color: #f0abfc; }
        #introduction-panel .step-explanation { margin-top: 1em; padding-left:1em; border-left: 2px solid #a78bfa; }
        #introduction-panel .step-explanation strong { color: #f0abfc;}

        .quiz-step-area { margin-bottom: 2rem; padding: 1rem; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem;}
        .quiz-step-area h4 { font-size: 1.2rem; font-weight: 600; color: #e9d5ff; margin-bottom: 0.75rem;}
        .sentence-context { font-size: 1.25rem; color: #f3e8ff; margin-bottom: 1rem; line-height: 1.8;}
        .sentence-context .blank { border-bottom: 2px dashed #c084fc; display: inline-block; min-width: 80px; text-align: center;}
        
        .draggable-item {
            background-image: linear-gradient(to right, #a78bfa, #8b5cf6); color: white;
            padding: 0.75rem 1.25rem; border-radius: 0.5rem; cursor: grab; font-weight: 600;
            font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: all 0.2s ease-out; border: 1px solid #c4b5fd;
            user-select: none; -webkit-user-select: none; -ms-user-select: none; margin: 0.25rem;
        }
        .draggable-item:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .draggable-item.dragging { opacity: 0.7; transform: rotate(2deg) scale(0.98); cursor: grabbing; }

        .drop-zone {
            min-height: 50px; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; 
            border: 2px dashed #a78bfa; display: flex; justify-content: center; 
            align-items: center; transition: all 0.25s ease-in-out;
            padding: 0.75rem; margin: 0.5rem 0;
        }
        .drop-zone.drag-over { background-color: rgba(167, 139, 250, 0.3); border-color: #c4b5fd; }
        .drop-zone.filled .draggable-item { cursor: default; }
        .drop-zone.correct { border-style: solid; border-color: #4ade80; background-color: rgba(74, 222, 128, 0.2); }
        .drop-zone.incorrect { border-style: solid; border-color: #f87171; background-color: rgba(248, 113, 113, 0.2); }

        .verb-pool-container { margin-top: 1rem; }
        .verb-type-drop-zones { display: flex; gap: 1rem; justify-content: space-around; margin-top: 1rem;}
        .verb-type-drop-zone { flex: 1; padding: 1rem; text-align: center; font-weight: 600; color: #ddd6fe;}


        .feedback-box { background-color: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: left; color: #e9d5ff; font-size: 0.95rem; }
        .feedback-box h4 { font-weight: 600; margin-bottom: 0.5rem; color: #f5d0fe; font-size: 1.05rem;}
        
        .btn {
            padding: 10px 20px; border-radius: 8px; font-size: 0.95rem; font-weight: 600;
            color: #581c87; background-color: #e9d5ff; 
            cursor: pointer; transition: all 0.3s ease;
            border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin: 0.5rem; 
        }
        .btn:disabled { background-color: #a78bfa !important; color: #6b21a8 !important; cursor: not-allowed; opacity: 0.7; }
        .btn:hover:not(:disabled) { background-color: #f3e8ff; }
        .btn-secondary { background-color: #9333ea; color:white; }
        .btn-secondary:hover:not(:disabled) { background-color: #a855f7; }
        
        .hidden { display: none !important; }
        .controls-area { margin-top: 1.5rem; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px;}
        .progress-score-area { display: flex; justify-content: space-between; width:100%; margin-bottom: 1rem; font-size: 0.875rem; color: #d8b4fe;}
    </style>
</head>
<body>
    <div class="card">
        <h1 class="mode-title">Boss & Victim Detective Mode</h1>
        <p class="mode-title-subtitle">Nominativ & Akkusativ F√§lle Meistern / Dominando los Casos Nominativo y Acusativo</p>

        <button id="toggle-introduction-btn" class="intro-toggle-button">Detektiv-Handbuch anzeigen / Mostrar Gu√≠a del Detective</button>

        <div id="introduction-panel" class="hidden">
            <h3>The Ultimate Detective's Guide to German Cases</h3>
            <p class="mode-title-subtitle">(The "Boss & Victim" Method)</p>

            <div class="golden-rule">
                <strong>THE GOLDEN RULES</strong><br>
                REMEMBER: NOMINATIVE = A CONDITION.<br>
                This sentence describes a state of being. It has ONLY A BOSS. The Boss is always NOMINATIVE.<br><br>
                REMEMBER: ACCUSATIVE = AN ACTION.<br>
                This sentence describes an action. It has a BOSS + A VICTIM. The Victim is always ACCUSATIVE.
            </div>

            <h4>YOUR CHEAT SHEET: These Verbs are ALWAYS "Condition"</h4>
            <p>If you see one of these verbs, you know immediately there is NO VICTIM. The case is solved quickly! Just find the Boss (Nominative).</p>
            <ul>
                <li><strong>sein</strong> (to be) -> <span class="german-example"><strong>Ich</strong> bin Student.</span></li>
                <li><strong>hei√üen</strong> (to be called) -> <span class="german-example"><strong>Meine Schwester</strong> hei√üt Anna.</span></li>
                <li><strong>werden</strong> (to become) -> <span class="german-example"><strong>Er</strong> wird Arzt.</span></li>
                <li><strong>bleiben</strong> (to stay/remain) -> <span class="german-example"><strong>Wir</strong> bleiben Freunde.</span></li>
                <li><strong>kommen</strong> (to come) -> <span class="german-example"><strong>Ich</strong> komme aus Spanien.</span></li>
                <li><strong>wohnen / leben</strong> (to live/reside) -> <span class="german-example"><strong>Er</strong> wohnt in M√ºnchen.</span></li>
                <li><strong>gehen / laufen</strong> (to go / to run) -> <span class="german-example"><strong>Wir</strong> gehen ins Kino.</span></li>
                <li><strong>schlafen</strong> (to sleep) -> <span class="german-example"><strong>Das Baby</strong> schl√§ft.</span></li>
                <li><strong>warten</strong> (to wait) -> <span class="german-example"><strong>Ich</strong> warte hier.</span></li>
                <li><strong>fahren</strong> (to drive/travel) -> <span class="german-example"><strong>Sie</strong> f√§hrt mit dem Bus.</span></li>
            </ul>

            <h4>THE 4-STEP DEDUCTION METHOD</h4>
            <p>Let's solve a case together.</p>
            <div class="eselsbruecke">
                <p><strong>THE CASE:</strong> "I have a brother!"</p>
                <p><strong>THE SENTENCE:</strong> Ich habe ___ Bruder.</p>
                <div class="step-explanation">
                    <strong>Step 1: Find the verb!</strong><br>
                    Find the verb in the sentence. Decide: Is it a "Condition" (from your cheat sheet) or an "Action"?<br>
                    Verb: <strong>habe</strong> (from "haben").<br>
                    Verdict: This is not on our "Condition" cheat sheet, so it's a clear <strong>ACTION</strong>.
                </div>
                <div class="step-explanation">
                    <strong>Step 2: Find the BOSS!</strong><br>
                    To find the boss of the sentence, use this question:<br>
                    Formula: "Wer oder was?" + (verb)?<br>
                    Investigation: "Wer oder was" hat?<br>
                    Answer: "Ich" (I).<br>
                    Result: The <strong>BOSS</strong> is "Ich". (The Boss is always Nominative).
                </div>
                <div class="step-explanation">
                    <strong>Step 3: Find the VICTIM!</strong><br>
                    (Remember: Only do this step if the verb is an ACTION!)<br>
                    To find the victim of the action, use this question:<br>
                    Formula: "Wen oder was?" + (verb) + (the Boss)?<br>
                    Investigation: "Wen oder was" habe ich?<br>
                    Answer: "Bruder" (brother).<br>
                    Result: The <strong>VICTIM</strong> is "Bruder".
                </div>
                <div class="step-explanation">
                    <strong>Step 4: PUT THE FUCKER BEHIND BARS!!!</strong><br>
                    The VICTIM always goes into the <strong>ACCUSATIVE</strong> case.<br>
                    The Evidence: The victim is "Bruder". This is a masculine noun (<strong>der</strong> Bruder).<br>
                    The Law: The Accusative case changes masculine articles:<br>
                    der becomes <strong>den</strong><br>
                    ein (a/an) becomes <strong>einen</strong><br>
                    The Sentence: Victim "der Bruder" => Akkusativ => "einen Bruder".<br>
                    <strong>CASE CLOSED:</strong> Ich habe <strong>einen Bruder</strong>.
                </div>
            </div>
            <div class="text-center mt-4">
                <button id="close-introduction-btn" class="btn btn-secondary">Handbuch schlie√üen / Cerrar Gu√≠a</button>
            </div>
        </div>

        <div id="quiz-area" class="hidden">
            <div id="progress-score-area" class="progress-score-area">
                <span id="progress-text-bv">Fall: 1/10</span>
                <span id="score-text-bv">Punkte: 0</span>
            </div>

            <div id="sentence-display-bv" class="sentence-context">Satz wird geladen...</div>
            
            <div id="step1-verb-type" class="quiz-step-area">
                <h4>Schritt 1: Verb-Typ / Paso 1: Tipo de Verbo</h4>
                <p>Ist das Verb eine "Kondition" (nur Boss) oder eine "Aktion" (Boss + Opfer)?</p>
                <p class="italic text-sm mb-2">Is the verb a "Condition" (Boss only) or an "Action" (Boss + Victim)?</p>
                <div id="verb-to-drag-container" class="draggable-pool" style="min-height:60px; margin-bottom:1rem;">
                    </div>
                <div class="verb-type-drop-zones">
                    <div id="condition-zone" class="drop-zone verb-type-drop-zone">KONDITION (Nur Boss)</div>
                    <div id="action-zone" class="drop-zone verb-type-drop-zone">AKTION (Boss + Opfer)</div>
                </div>
                <div id="step1-feedback" class="feedback-box hidden"></div>
            </div>

            <div id="step2-find-boss" class="quiz-step-area hidden">
                <h4>Schritt 2: Finde den BOSS! / Paso 2: ¬°Encuentra al JEFE!</h4>
                <p id="boss-question">Wer oder was ...?</p>
                <div id="boss-words-pool" class="draggable-pool"></div>
                <div id="boss-drop-zone" class="drop-zone">BOSS (Nominativ)</div>
                <div id="step2-feedback" class="feedback-box hidden"></div>
            </div>

            <div id="step3-find-victim" class="quiz-step-area hidden">
                <h4>Schritt 3: Finde das OPFER! / Paso 3: ¬°Encuentra a la V√çCTIMA!</h4>
                <p id="victim-question">Wen oder was ...?</p>
                <div id="victim-words-pool" class="draggable-pool"></div>
                <div id="victim-drop-zone" class="drop-zone">OPFER (Akkusativ)</div>
                <div id="step3-feedback" class="feedback-box hidden"></div>
            </div>

            <div id="step4-choose-article" class="quiz-step-area hidden">
                <h4>Schritt 4: W√§hle den Artikel! / Paso 4: ¬°Elige el Art√≠culo!</h4>
                <p id="article-prompt">Der Satz: <span id="sentence-for-article"></span></p>
                <p class="italic text-sm mb-2">Das <span id="victim-or-boss-for-article">OPFER</span> ist <strong id="noun-for-article"></strong> (<span id="gender-for-article"></span>) und braucht den <strong id="case-for-article"></strong> Fall.</p>
                <div id="article-options-pool" class="draggable-pool">
                    </div>
                <div id="article-drop-zone" class="drop-zone">Artikel hier</div>
                <div id="step4-feedback" class="feedback-box hidden"></div>
            </div>

            <div class="controls-area">
                <button id="next-step-btn" class="btn btn-primary">N√§chster Schritt / Siguiente Paso</button>
                <button id="next-case-btn" class="btn btn-secondary hidden">N√§chster Fall / Siguiente Caso</button>
            </div>
        </div>
        <div class="mt-8 pt-4 border-t border-gray-200 border-opacity-20">
             <a href="index.html" class="btn btn-secondary btn-sm">‚Üê Hauptmen√º / Men√∫ Principal</a>
        </div>
    </div>

    <script>
        let allBossVictimTasks = [];
        let currentTaskDataBV = null;
        let currentTaskIndexBV = 0;
        let scoreBV = 0;
        let tasksForRoundBV = [];
        let currentStepBV = 1; // 1: Verb Type, 2: Boss, 3: Victim, 4: Article

        let draggedLegoItem = null;
        let touchLegoOffsetX = 0, touchLegoOffsetY = 0;
        let activeLegoTouchClone = null;


        // DOM Elements
        const toggleIntroductionBtnBV = document.getElementById('toggle-introduction-btn');
        const introductionPanelBV = document.getElementById('introduction-panel');
        const closeIntroductionBtnBV = document.getElementById('close-introduction-btn');
        const quizAreaBV = document.getElementById('quiz-area');

        const sentenceDisplayBV = document.getElementById('sentence-display-bv');
        const progressTextBV = document.getElementById('progress-text-bv');
        const scoreTextBV = document.getElementById('score-text-bv');

        // Step 1
        const step1VerbTypeEl = document.getElementById('step1-verb-type');
        const verbToDragContainerEl = document.getElementById('verb-to-drag-container');
        const conditionZoneEl = document.getElementById('condition-zone');
        const actionZoneEl = document.getElementById('action-zone');
        const step1FeedbackEl = document.getElementById('step1-feedback');

        // Step 2
        const step2FindBossEl = document.getElementById('step2-find-boss');
        const bossQuestionEl = document.getElementById('boss-question');
        const bossWordsPoolEl = document.getElementById('boss-words-pool');
        const bossDropZoneEl = document.getElementById('boss-drop-zone');
        const step2FeedbackEl = document.getElementById('step2-feedback');

        // Step 3
        const step3FindVictimEl = document.getElementById('step3-find-victim');
        const victimQuestionEl = document.getElementById('victim-question');
        const victimWordsPoolEl = document.getElementById('victim-words-pool');
        const victimDropZoneEl = document.getElementById('victim-drop-zone');
        const step3FeedbackEl = document.getElementById('step3-feedback');

        // Step 4
        const step4ChooseArticleEl = document.getElementById('step4-choose-article');
        const articlePromptEl = document.getElementById('article-prompt');
        const sentenceForArticleEl = document.getElementById('sentence-for-article');
        const victimOrBossForArticleEl = document.getElementById('victim-or-boss-for-article');
        const nounForArticleEl = document.getElementById('noun-for-article');
        const genderForArticleEl = document.getElementById('gender-for-article');
        const caseForArticleEl = document.getElementById('case-for-article');
        const articleOptionsPoolEl = document.getElementById('article-options-pool');
        const articleDropZoneEl = document.getElementById('article-drop-zone');
        const step4FeedbackEl = document.getElementById('step4-feedback');

        const nextStepBtn = document.getElementById('next-step-btn');
        const nextCaseBtn = document.getElementById('next-case-btn');
        
        function showFeedback(el, message, isCorrect) {
            el.innerHTML = message;
            el.classList.remove('hidden');
            el.style.color = isCorrect ? '#a7f3d0' : '#fca5a5'; // Light Green / Light Red
        }

        function createLegoDraggable(text, dataType, dataValue) {
            const item = document.createElement('div');
            item.classList.add('draggable-item');
            item.textContent = text;
            item.draggable = true;
            item.dataset.dataType = dataType;
            item.dataset.value = dataValue || text; // Store actual value if different from text
            item.addEventListener('dragstart', handleLegoDragStart);
            item.addEventListener('dragend', handleLegoDragEnd);
            item.addEventListener('touchstart', handleLegoTouchStart, { passive: false });
            // No click to return for this simplified first step
            return item;
        }
        
        function setupDropZone(zone, acceptedDataType, onDropCallback) {
            zone.innerHTML = zone.dataset.defaultText || ''; // Reset text or show placeholder
            zone.classList.remove('filled', 'correct', 'incorrect');
            zone.dataset.acceptedType = acceptedDataType;
            zone.ondragover = handleLegoDragOver;
            zone.ondragenter = handleLegoDragEnter;
            zone.ondragleave = handleLegoDragLeave;
            zone.ondrop = (event) => onDropCallback(event, zone);
        }

        // --- Drag & Drop Handlers (adapted) ---
        function handleLegoDragStart(e) {
            draggedLegoItem = e.target.closest('.draggable-item');
            e.dataTransfer.setData('text/plain', draggedLegoItem.dataset.value);
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => draggedLegoItem.classList.add('dragging'), 0);
        }
        function handleLegoDragEnd() { if (draggedLegoItem) draggedLegoItem.classList.remove('dragging'); draggedLegoItem = null; document.querySelectorAll('.drop-zone.drag-over').forEach(el => el.classList.remove('drag-over')); }
        function handleLegoDragOver(e) { e.preventDefault(); }
        function handleLegoDragEnter(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.drop-zone');
            if (draggedLegoItem && dropTarget && dropTarget.dataset.acceptedType === draggedLegoItem.dataset.dataType && !dropTarget.querySelector('.draggable-item')) {
                dropTarget.classList.add('drag-over');
            }
        }
        function handleLegoDragLeave(e) { const dropTarget = e.target.closest('.drop-zone'); if (dropTarget) dropTarget.classList.remove('drag-over'); }
        
        // Touch handlers need similar adaptation if fully implemented. For now, focusing on Step 1 drag-drop.
         function handleLegoTouchStart(e) {
            draggedLegoItem = e.target.closest('.draggable-item');
            if (draggedLegoItem) {
                if (e.cancelable) e.preventDefault();
                activeLegoTouchClone = draggedLegoItem.cloneNode(true);
                activeLegoTouchClone.classList.add('dragging');
                activeLegoTouchClone.style.position = 'fixed'; activeLegoTouchClone.style.pointerEvents = 'none'; 
                activeLegoTouchClone.style.zIndex = '1000';
                activeLegoTouchClone.style.width = draggedLegoItem.offsetWidth + 'px'; activeLegoTouchClone.style.height = draggedLegoItem.offsetHeight + 'px';
                document.body.appendChild(activeLegoTouchClone);
                const rect = draggedLegoItem.getBoundingClientRect();
                touchLegoOffsetX = e.touches[0].clientX - rect.left; touchLegoOffsetY = e.touches[0].clientY - rect.top;
                activeLegoTouchClone.style.left = (e.touches[0].clientX - touchLegoOffsetX) + 'px';
                activeLegoTouchClone.style.top = (e.touches[0].clientY - touchLegoOffsetY) + 'px';
                draggedLegoItem.style.opacity = '0.4';
                document.addEventListener('touchmove', handleLegoTouchMove, { passive: false });
                document.addEventListener('touchend', handleLegoTouchEnd, { once: true });
            }
        }
        function handleLegoTouchMove(e) {
            if (activeLegoTouchClone) {
                if (e.cancelable) e.preventDefault();
                let currentX = e.touches[0].clientX; let currentY = e.touches[0].clientY;
                activeLegoTouchClone.style.left = (currentX - touchLegoOffsetX) + 'px';
                activeLegoTouchClone.style.top = (currentY - touchLegoOffsetY) + 'px';
                document.querySelectorAll('.drop-zone.drag-over').forEach(box => box.classList.remove('drag-over'));
                activeLegoTouchClone.style.display = 'none'; 
                const elementBelow = document.elementFromPoint(currentX, currentY);
                activeLegoTouchClone.style.display = ''; 
                if (elementBelow) {
                    const dropBoxBelow = elementBelow.closest('.drop-zone');
                    if (dropBoxBelow && draggedLegoItem && dropBoxBelow.dataset.acceptedType === draggedLegoItem.dataset.dataType && !dropBoxBelow.querySelector('.draggable-item')) { 
                        dropBoxBelow.classList.add('drag-over'); 
                    }
                }
            }
        }
        function handleLegoTouchEnd(e) {
            document.removeEventListener('touchmove', handleLegoTouchMove);
            if (activeLegoTouchClone && draggedLegoItem) {
                activeLegoTouchClone.style.display = 'none';
                const dropTargetElement = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                let droppedSuccessfully = false;
                if (dropTargetElement) {
                    const dropBox = dropTargetElement.closest('.drop-zone');
                    if (dropBox && dropBox.dataset.acceptedType === draggedLegoItem.dataset.dataType && !dropBox.querySelector('.draggable-item')) {
                        dropBox.innerHTML = ''; // Clear placeholder before appending
                        dropBox.appendChild(draggedLegoItem);
                        dropBox.classList.add('filled');
                        droppedSuccessfully = true;
                         // Call the specific onDrop for Step 1
                        if(dropBox === conditionZoneEl || dropBox === actionZoneEl) {
                            handleVerbTypeDrop(null, dropBox, draggedLegoItem); // Pass dragged item explicitly for touch
                        }
                    }
                }
                if (!droppedSuccessfully) { // Return to original pool if not dropped in a valid empty slot
                    verbToDragContainerEl.appendChild(draggedLegoItem);
                }
                draggedLegoItem.style.opacity = '1';
                draggedLegoItem.classList.remove('dragging');
                if(activeLegoTouchClone.parentNode) document.body.removeChild(activeLegoTouchClone);
            }
            activeLegoTouchClone = null; draggedLegoItem = null; touchLegoOffsetX = 0; touchLegoOffsetY = 0;
            document.querySelectorAll('.drop-zone.drag-over').forEach(box => box.classList.remove('drag-over'));
        }


        // --- Step 1: Verb Type Logic ---
        function setupStep1_VerbType() {
            currentStepBV = 1;
            step1VerbTypeEl.classList.remove('hidden');
            step2FindBossEl.classList.add('hidden');
            step3FindVictimEl.classList.add('hidden');
            step4ChooseArticleEl.classList.add('hidden');
            nextStepBtn.textContent = "Schritt 1 Pr√ºfen / Verificar Paso 1";
            nextStepBtn.disabled = true; // Enabled when verb is dropped
            nextCaseBtn.classList.add('hidden');
            step1FeedbackEl.classList.add('hidden');

            verbToDragContainerEl.innerHTML = '';
            const verbItem = createLegoDraggable(currentTaskDataBV.verb_in_sentence, 'verb', currentTaskDataBV.verb_infinitive);
            verbToDragContainerEl.appendChild(verbItem);

            conditionZoneEl.dataset.defaultText = "KONDITION (Nur Boss)";
            actionZoneEl.dataset.defaultText = "AKTION (Boss + Opfer)";
            setupDropZone(conditionZoneEl, 'verb', (event, zone) => handleVerbTypeDrop(event, zone));
            setupDropZone(actionZoneEl, 'verb', (event, zone) => handleVerbTypeDrop(event, zone));
        }

        function handleVerbTypeDrop(event, zone, itemFromTouch = null) {
            if(event) event.preventDefault(); // For standard drag-drop
            const droppedItem = itemFromTouch || draggedLegoItem; // Use item from touch if available

            if (zone && droppedItem && zone.dataset.acceptedType === droppedItem.dataset.dataType) {
                if (!zone.querySelector('.draggable-item')) { // Only if empty
                    zone.innerHTML = ''; // Clear placeholder text
                    zone.appendChild(droppedItem);
                    zone.classList.add('filled');
                    droppedItem.classList.remove('dragging');
                    // Disable other zone to prevent dragging to both
                    (zone === conditionZoneEl ? actionZoneEl : conditionZoneEl).innerHTML = (zone === conditionZoneEl ? actionZoneEl : conditionZoneEl).dataset.defaultText;
                     (zone === conditionZoneEl ? actionZoneEl : conditionZoneEl).classList.remove('filled');
                }
            }
            if(zone) zone.classList.remove('drag-over');
            if(!itemFromTouch) draggedLegoItem = null; // Clear if it was a standard drag-drop
            
            // Enable check button if one zone is filled
            if (conditionZoneEl.querySelector('.draggable-item') || actionZoneEl.querySelector('.draggable-item')) {
                nextStepBtn.disabled = false;
            }
        }
        
        function checkStep1_VerbType() {
            const conditionDroppedItem = conditionZoneEl.querySelector('.draggable-item');
            const actionDroppedItem = actionZoneEl.querySelector('.draggable-item');
            let chosenType = null;
            let correct = false;

            if (conditionDroppedItem) chosenType = "Condition";
            else if (actionDroppedItem) chosenType = "Action";

            if (chosenType && chosenType === currentTaskDataBV.verb_type) {
                showFeedback(step1FeedbackEl, "Richtig! / ¬°Correcto!", true);
                (chosenType === "Condition" ? conditionZoneEl : actionZoneEl).classList.add('correct');
                correct = true;
            } else if (chosenType) {
                showFeedback(step1FeedbackEl, `Falsch. '${currentTaskDataBV.verb_infinitive}' ist ${currentTaskDataBV.verb_type}. / Incorrecto. '${currentTaskDataBV.verb_infinitive}' es ${currentTaskDataBV.verb_type}.`, false);
                (chosenType === "Condition" ? conditionZoneEl : actionZoneEl).classList.add('incorrect');
            } else {
                showFeedback(step1FeedbackEl, "Bitte ziehe das Verb. / Por favor, arrastra el verbo.", false);
                return false; // Not submitted
            }
            nextStepBtn.textContent = "N√§chster Schritt / Siguiente Paso";
            return correct;
        }


        // --- Placeholder for other steps ---
        function setupStep2_FindBoss() { currentStepBV = 2; /* ... more logic ... */ step1VerbTypeEl.classList.add('hidden'); step2FindBossEl.classList.remove('hidden'); nextStepBtn.textContent = "Schritt 2 Pr√ºfen / Verificar Paso 2"; showFeedback(step2FeedbackEl, "TODO: Implement Boss finding LEGO", false); }
        function checkStep2_FindBoss() { /* ... */ return true; }
        function setupStep3_FindVictim() { currentStepBV = 3; /* ... */ step2FindBossEl.classList.add('hidden'); step3FindVictimEl.classList.remove('hidden'); nextStepBtn.textContent = "Schritt 3 Pr√ºfen / Verificar Paso 3"; showFeedback(step3FeedbackEl, "TODO: Implement Victim finding LEGO", false); }
        function checkStep3_FindVictim() { /* ... */ return true; }
        function setupStep4_ChooseArticle() { currentStepBV = 4; /* ... */ step3FindVictimEl.classList.add('hidden'); step4ChooseArticleEl.classList.remove('hidden'); nextStepBtn.textContent = "Antwort Pr√ºfen / Comprobar Respuesta"; showFeedback(step4FeedbackEl, "TODO: Implement Article LEGO/Choice", false); }
        function checkStep4_ChooseArticle() { /* ... */ scoreBV++; updateProgressAndScoreBV(); return true; }


        // --- Main Game Flow ---
        async function loadDataAndStart() {
            try {
                const response = await fetch('boss_victim_tasks.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allBossVictimTasks = await response.json();
                if (allBossVictimTasks.length === 0) throw new Error("boss_victim_tasks.json is empty.");
                introductionPanelBV.classList.remove('hidden'); // Show intro first
                quizAreaBV.classList.add('hidden');
                toggleIntroductionBtnBV.textContent = "Handbuch schlie√üen / Cerrar Gu√≠a";
            } catch (error) {
                console.error("Could not load tasks:", error);
                modeSelectionCardEl.innerHTML = `<h2 class="mode-title text-red-500">Error</h2><p>Could not load tasks: ${error.message}</p>`;
            }
        }

        function startNewRoundBV() {
            currentTaskIndexBV = 0;
            scoreBV = 0;
            shuffleArray(allBossVictimTasks);
            tasksForRoundBV = allBossVictimTasks.slice(0, Math.min(5, allBossVictimTasks.length)); // e.g., 5 tasks per round
            if (tasksForRoundBV.length === 0) {
                sentenceDisplayBV.textContent = "Keine Aufgaben geladen."; return;
            }
            loadNextCaseBV();
            updateProgressAndScoreBV();
        }

        function loadNextCaseBV() {
            if (currentTaskIndexBV >= tasksForRoundBV.length) {
                quizAreaBV.innerHTML = `<h2 class="mode-title">Runde Beendet!</h2><p class="stats-summary">Dein Ergebnis: ${scoreBV} / ${tasksForRoundBV.length}</p>`;
                nextCaseBtn.textContent = "Neue Runde / Nueva Ronda";
                nextCaseBtn.onclick = startNewRoundBV; // Reassign for new round
                nextCaseBtn.classList.remove('hidden');
                nextStepBtn.classList.add('hidden');
                return;
            }
            currentTaskDataBV = tasksForRoundBV[currentTaskIndexBV];
            sentenceDisplayBV.innerHTML = currentTaskDataBV.sentence_for_display.replace("___", `<span class="blank"> ___ </span>`);
            
            // Reset and setup Step 1
            setupStep1_VerbType();
            
            updateProgressAndScoreBV();
            nextStepBtn.classList.remove('hidden');
            nextCaseBtn.classList.add('hidden');
        }
        
        nextStepBtn.addEventListener('click', () => {
            let stepCorrect = false;
            if (currentStepBV === 1) {
                stepCorrect = checkStep1_VerbType();
                if (stepCorrect) {
                     // If verb type is 'Condition', skip step 3 (Victim)
                    if (currentTaskDataBV.verb_type === "Condition") {
                        // Proceed to step 2 (Boss), then directly to step 4 (Article for Boss)
                        // For now, placeholder for future steps
                        setTimeout(() => { setupStep2_FindBoss(); /* then eventually setupStep4_ChooseArticle() for Boss */ }, 1000); 
                    } else { // Action verb
                        setTimeout(() => { setupStep2_FindBoss(); }, 1000);
                    }
                }
            } else if (currentStepBV === 2) {
                stepCorrect = checkStep2_FindBoss();
                if (stepCorrect) {
                    if (currentTaskDataBV.verb_type === "Action") {
                       setTimeout(() => { setupStep3_FindVictim(); }, 1000);
                    } else { // Condition verb, boss found, go to article for boss
                       setTimeout(() => { setupStep4_ChooseArticle(); }, 1000);
                    }
                }
            } else if (currentStepBV === 3) { // Only reached if Action verb
                stepCorrect = checkStep3_FindVictim();
                if (stepCorrect) {
                    setTimeout(() => { setupStep4_ChooseArticle(); }, 1000);
                }
            } else if (currentStepBV === 4) {
                stepCorrect = checkStep4_ChooseArticle();
                if (stepCorrect) {
                    nextStepBtn.classList.add('hidden');
                    nextCaseBtn.classList.remove('hidden');
                }
            }
            // If a step is incorrect, the user needs to fix it before "Next Step" enables again or changes function
            // This needs more sophisticated logic for re-enabling or guiding correction.
            // For now, if incorrect, it just shows feedback. The "Next Step" button would ideally become "Try Step Again" or be disabled.
            if(!stepCorrect && currentStepBV < 4) {
                nextStepBtn.disabled = true; // Simple disable, user has to re-drag to re-enable for step 1
                 // More robust: provide a "Reset Step" button
            }

        });

        nextCaseBtn.addEventListener('click', () => {
            currentTaskIndexBV++;
            loadNextCaseBV();
        });

        function updateProgressAndScoreBV() {
            if (tasksForRoundBV.length > 0) {
                progressTextBV.textContent = `Fall: ${Math.min(currentTaskIndexBV + 1, tasksForRoundBV.length)}/${tasksForRoundBV.length}`;
            } else {
                progressTextBV.textContent = `Fall: 0/0`;
            }
            scoreTextBV.textContent = `Punkte: ${scoreBV}`;
        }

        toggleIntroductionBtnBV.addEventListener('click', () => {
            const introIsHidden = introductionPanelBV.classList.toggle('hidden');
            quizAreaBV.classList.toggle('hidden', !introIsHidden);
            toggleIntroductionBtnBV.textContent = introIsHidden ? "Handbuch anzeigen / Mostrar Gu√≠a" : "Handbuch schlie√üen / Cerrar Gu√≠a";
            if (introIsHidden && tasksForRoundBV.length === 0 && allBossVictimTasks.length > 0) {
                 startNewRoundBV(); // Start quiz if intro is closed and quiz hasn't started
            }
        });
        closeIntroductionBtnBV.addEventListener('click', () => {
            introductionPanelBV.classList.add('hidden');
            quizAreaBV.classList.remove('hidden');
            toggleIntroductionBtnBV.textContent = "Handbuch anzeigen / Mostrar Gu√≠a";
             if (tasksForRoundBV.length === 0 && allBossVictimTasks.length > 0) {
                 startNewRoundBV();
            }
        });

        document.addEventListener('DOMContentLoaded', loadDataAndStart);
    </script>
</body>
</html>