<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Akkusativ & Dativ Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #a855f7, #9333ea, #7e22ce, #6b21a8, #581c87); /* Purple Gradient */
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            margin: 0;
            padding: 16px; 
            color: #f3e8ff; 
            overflow-x: auto;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 24px; 
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 800px; /* Increased max-width for intro content */
            margin-top: 2vh;
            margin-bottom: 2vh;
        }
        @media (min-width: 768px) { .card { padding: 32px; } }

        .mode-title { font-size: 1.6rem; sm:font-size: 1.75rem; font-weight: 700; color: #e9d5ff; margin-bottom: 4px; } 
        .mode-title-subtitle { font-size: 0.9rem; sm:font-size: 1rem; color: #d8b4fe; margin-bottom: 24px; }

        .intro-toggle-button {
            background-color: rgba(255,255,255,0.1); color: #e9d5ff;
            border: 1px solid #d8b4fe; padding: 0.5rem 1rem; border-radius: 0.5rem;
            cursor: pointer; transition: background-color 0.3s; margin-bottom: 1.5rem;
        }
        .intro-toggle-button:hover { background-color: rgba(255,255,255,0.2); }
        
        #introduction-panel {
            background-color: rgba(40, 10, 70, 0.3); /* Darker, slightly transparent purple */
            padding: 1.5rem; border-radius: 0.75rem; margin-top: 1rem; margin-bottom: 2rem;
            text-align: left; color: #ede9fe; 
            border: 1px solid rgba(255,255,255,0.2);
            max-height: 75vh; overflow-y: auto; 
        }
        #introduction-panel h3 { /* Main section titles (e.g., El Caso Acusativo) */
            font-size: 1.4rem; font-weight: 700; color: #f0abfc; /* Bright Pink/Magenta */
            margin-top: 1.8rem; margin-bottom: 0.5rem; 
            padding-bottom: 0.4rem; border-bottom: 2px solid #c084fc; /* Lighter Purple border */
        }
        #introduction-panel h4 { /* Sub-section titles (e.g., Verbos Típicos) */
            font-size: 1.15rem; font-weight: 600; color: #e9d5ff; /* Lightest Purple */
            margin-top: 1.5rem; margin-bottom: 0.75rem;
        }
        #introduction-panel h3:first-child { margin-top: 0;}
        #introduction-panel p, #introduction-panel li { font-size: 0.95rem; line-height: 1.7; margin-bottom: 0.85rem; color: #ede9fe;}
        #introduction-panel .explanation-lang-marker { font-size: 0.8rem; font-weight: bold; color: #f5d0fe; display: block; margin-bottom: 0.25rem;}
        #introduction-panel ul { list-style-type: none; padding-left: 0.5rem; margin-bottom:1rem;}
        #introduction-panel li { background-color: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;}
        #introduction-panel li .german-example { font-style: normal; color: #f3e8ff; display: block; margin-top: 0.15rem;}
        #introduction-panel li .german-example strong { color: #f0abfc; } /* Highlight key parts */
        #introduction-panel li .example-translation { font-size:0.85rem; font-style: italic; color: #d8b4fe; display: block; margin-top:0.15rem;}


        #introduction-panel table { 
            width: 100%; margin-top: 1rem; margin-bottom: 1.5rem; 
            border-collapse: separate; border-spacing: 0; font-size: 0.85rem; 
            border: 1px solid #a855f7; border-radius: 0.5rem; overflow: hidden; /* For rounded corners on table */
        }
        #introduction-panel th, #introduction-panel td { 
            border-bottom: 1px solid #a855f7; padding: 0.75rem 0.6rem; text-align: left; 
        }
        #introduction-panel tr:last-child td { border-bottom: none; }
        #introduction-panel tr td:not(:last-child), #introduction-panel tr th:not(:last-child) { border-right: 1px solid #a855f7; }
        #introduction-panel th { 
            background-color: rgba(167, 139, 250, 0.25); color: #f5d0fe; font-weight: 600;
        }
        #introduction-panel td strong { color: #f0abfc; font-weight: 600; } 
        #introduction-panel .eselsbruecke { 
            background-color: rgba(255,255,255,0.07); 
            padding: 1rem; border-radius: 0.5rem; 
            margin: 1rem 0; font-style: italic; 
            border-left: 4px solid #f0abfc; /* Pink border */
            color: #f5f3ff;
        }
        #introduction-panel .eselsbruecke strong { color: #f0abfc;}


        .quiz-content-area { /* Styles if needed */ }
        .sentence-display-container {
            background-color: rgba(255, 255, 255, 0.05); padding: 1.5rem;
            border-radius: 0.75rem; margin-bottom: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sentence-german { font-size: 1.25rem; sm:font-size: 1.5rem; line-height: 2; color: #f3e8ff; margin-bottom: 0.5rem;}
        .sentence-german .blank-placeholder { display: inline-block; border-bottom: 2px dashed #c084fc; min-width: 120px; padding: 0 0.25rem; }
        .noun-prompt-js { font-size: 0.9rem; color: #d8b4fe; font-style: italic; margin-top: 0.25rem; margin-bottom: 0.75rem; }
        .noun-prompt-js strong { color: #f3e8ff; font-weight: 600; }
        .sentence-translation { font-size: 0.85rem; sm:font-size:0.9rem; font-style: italic; color: #e9d5ff; margin-top: 0.25rem; }

        .options-container { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
        @media (min-width: 640px) { .options-container { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }

        .option-btn {
            background-color: #7e22ce; color: white; padding: 0.75rem 1rem;
            border-radius: 0.5rem; border: 2px solid transparent; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease; width: 100%;
        }
        .option-btn:hover:not(:disabled) { background-color: #9333ea; border-color: #a855f7; }
        .option-btn.selected { background-color: #c084fc; border-color: #e9d5ff; color: #3b0764; }
        .option-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .option-btn.correct { background-color: #22c55e !important; border-color: #16a34a !important; color:white !important;}
        .option-btn.incorrect { background-color: #ef4444 !important; border-color: #dc2626 !important; color:white !important;}

        .feedback-box {
            background-color: rgba(0,0,0,0.25); padding: 1rem; border-radius: 0.5rem;
            margin-top: 1rem; text-align: left; color: #e9d5ff; font-size: 0.9rem;
        }
        .feedback-box h4 { font-weight: 600; margin-bottom: 0.5rem; color: #f5d0fe; font-size: 1rem;}
        .feedback-box p { line-height: 1.6; }
        .feedback-box .german-explanation { margin-bottom: 0.5rem;}
        .feedback-box .spanish-explanation { font-style: italic; color: #d8b4fe;}
        
        .btn {
            padding: 10px 20px; border-radius: 8px; font-size: 0.95rem; font-weight: 600;
            color: #581c87; background-color: #e9d5ff; 
            cursor: pointer; transition: all 0.3s ease;
            border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin: 0.5rem; 
        }
        .btn:disabled { background-color: #a78bfa !important; color: #6b21a8 !important; cursor: not-allowed; opacity: 0.7; }
        .btn:hover:not(:disabled) { background-color: #f3e8ff; }
        .btn-secondary { background-color: #9333ea; color:white; }
        .btn-secondary:hover:not(:disabled) { background-color: #a855f7; }
        
        .hidden { display: none !important; }
        .controls-area { margin-top: 1.5rem; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px;}
        .progress-score-area { display: flex; justify-content: space-between; width:100%; margin-bottom: 1rem; font-size: 0.875rem; color: #d8b4fe;}
    </style>
</head>
<body>
    <div class="card">
        <h1 class="mode-title">Akkusativ & Dativ Trainer</h1>
        <p class="mode-title-subtitle">Entrenador de Casos Acusativo y Dativo</p>

        <button id="toggle-introduction-btn" class="intro-toggle-button">Einführung anzeigen / Mostrar Introducción</button>

        <div id="introduction-panel" class="hidden"> <h3><span class="explanation-lang-marker">ES</span>¿Qué son los casos gramaticales? / <span class="explanation-lang-marker">EN</span>What are grammatical cases?</h3>
            <p><span class="explanation-lang-marker">ES</span>En alemán, los sustantivos y sus acompañantes (artículos, adjetivos) cambian de forma según la función que desempeñan en la oración. Estas formas se llaman casos (Kasus). Los cuatro casos son Nominativo, Acusativo, Dativo y Genitivo. Aquí nos concentraremos en el Acusativo y el Dativo.</p>
            <p><span class="explanation-lang-marker">EN</span>In German, nouns and their companions (articles, adjectives) change their form depending on their function in the sentence. These forms are called cases (Kasus). The four cases are Nominative, Accusative, Dative, and Genitive. Here, we will focus on Accusative and Dative.</p>

            <h3><span class="explanation-lang-marker">ES</span>Nominativo (El caso "Quién/Qué") / <span class="explanation-lang-marker">EN</span>Nominative (The "Who/What" Case)</h3>
            <p><span class="explanation-lang-marker">ES</span>El Nominativo es el caso básico. Designa al sujeto de la oración, es decir, quién o qué realiza una acción. Se pregunta: <strong>Wer oder Was?</strong> (¿Quién o Qué?).</p>
            <p><span class="explanation-lang-marker">EN</span>The Nominative is the basic case. It identifies the subject of the sentence – who or what is performing an action. You ask: <strong>Wer oder Was?</strong> (Who or What?).</p>
            <div class="example-sentence">DE: <strong>Der Mann</strong> liest. <span class="example-translation">(ES: El hombre lee. / EN: The man reads.)</span></div>

            <h3><span class="explanation-lang-marker">ES</span>Acusativo (El caso del objeto directo) / <span class="explanation-lang-marker">EN</span>Accusative (The direct object case)</h3>
            <p><span class="explanation-lang-marker">ES</span>El Acusativo a menudo designa el objeto directo, es decir, sobre quién o qué recae directamente la acción del sujeto. Se pregunta: <strong>Wen oder Was?</strong> (¿A quién o Qué?).</p>
            <p><span class="explanation-lang-marker">EN</span>The Accusative often identifies the direct object – who or what is directly affected by the subject's action. You ask: <strong>Wen oder Was?</strong> (Whom or What?).</p>
            
            <h4><span class="explanation-lang-marker">ES</span>Verbos Típicos con Acusativo / <span class="explanation-lang-marker">EN</span>Typical Verbs with Accusative:</h4>
            <ul>
                <li><span class="german-verb">haben</span> (tener/to have): <span class="german-example">Ich habe <strong>einen Hund</strong>.</span> <span class="example-translation">(ES: Tengo un perro. / EN: I have a dog.)</span></li>
                <li><span class="german-verb">sehen</span> (ver/to see): <span class="german-example">Siehst du <strong>den Vogel</strong>?</span> <span class="example-translation">(ES: ¿Ves el pájaro? / EN: Do you see the bird?)</span></li>
                <li><span class="german-verb">kaufen</span> (comprar/to buy): <span class="german-example">Er kauft <strong>eine Blume</strong>.</span> <span class="example-translation">(ES: Él compra una flor. / EN: He buys a flower.)</span></li>
                <li><span class="german-verb">lesen</span> (leer/to read): <span class="german-example">Wir lesen <strong>das Buch</strong>.</span> <span class="example-translation">(ES: Leemos el libro. / EN: We read the book.)</span></li>
                <li><span class="german-verb">brauchen</span> (necesitar/to need): <span class="german-example">Ihr braucht <strong>einen Stift</strong>.</span> <span class="example-translation">(ES: Necesitáis un bolígrafo. / EN: You all need a pen.)</span></li>
            </ul>
            <h4><span class="explanation-lang-marker">ES</span>Preposiciones Siempre con Acusativo / <span class="explanation-lang-marker">EN</span>Prepositions Always with Accusative:</h4>
            <p><strong>durch, für, gegen, ohne, um</strong> (Mnemotecnia/Mnemonic: "DUFOG")</p>
            <ul>
                <li><span class="german-verb">durch</span> (a través de/through): <span class="german-example">Wir gehen durch <strong>den Park</strong>.</span> <span class="example-translation">(ES: Caminamos por el parque. / EN: We walk through the park.)</span></li>
                <li><span class="german-verb">für</span> (para/for): <span class="german-example">Das ist für <strong>meine Mutter</strong>.</span> <span class="example-translation">(ES: Esto es para mi madre. / EN: This is for my mother.)</span></li>
            </ul>
            <h4><span class="explanation-lang-marker">ES</span>Artículos en Acusativo / <span class="explanation-lang-marker">EN</span>Articles in Accusative</h4>
            <table><thead><tr><th>Género/Gender</th><th>Definido/Definite</th><th>Indefinido/Indefinite</th><th>Negación/Negation (kein-)</th></tr></thead><tbody><tr><td>Maskulin (der)</td><td><strong>den</strong></td><td><strong>einen</strong></td><td><strong>keinen</strong></td></tr><tr><td>Feminin (die)</td><td><strong>die</strong></td><td><strong>eine</strong></td><td><strong>keine</strong></td></tr><tr><td>Neutrum (das)</td><td><strong>das</strong></td><td><strong>ein</strong></td><td><strong>kein</strong></td></tr><tr><td>Plural (die)</td><td><strong>die</strong></td><td>- (keine)</td><td><strong>keine</strong></td></tr></tbody></table>

            <h3><span class="explanation-lang-marker">ES</span>Dativo (El caso del objeto indirecto) / <span class="explanation-lang-marker">EN</span>Dative (The indirect object case)</h3>
            <p><span class="explanation-lang-marker">ES</span>El Dativo a menudo designa el objeto indirecto: a quién se da algo, para quién se hace algo. Se pregunta: <strong>Wem?</strong> (¿A quién?).</p>
            <p><span class="explanation-lang-marker">EN</span>The Dative often identifies the indirect object: to whom something is given, for whom something is done. You ask: <strong>Wem?</strong> (To whom?).</p>
            <h4><span class="explanation-lang-marker">ES</span>Verbos Típicos con Dativo / <span class="explanation-lang-marker">EN</span>Typical Verbs with Dative:</h4>
            <ul>
                <li><span class="german-verb">helfen</span> (ayudar/to help): <span class="german-example">Ich helfe <strong>dir</strong>. / Er hilft <strong>dem Mann</strong>.</span> <span class="example-translation">(ES: Te ayudo. / Él ayuda al hombre. EN: I help you. / He helps the man.)</span></li>
                <li><span class="german-verb">danken</span> (agradecer/to thank): <span class="german-example">Wir danken <strong>Ihnen</strong>. / Sie dankt <strong>ihrer Freundin</strong>.</span> <span class="example-translation">(ES: Le agradecemos a usted. / Ella agradece a su amiga. EN: We thank you (formal). / She thanks her friend.)</span></li>
                <li><span class="german-verb">gefallen</span> (gustar/to please): <span class="german-example">Das Auto gefällt <strong>mir</strong>.</span> <span class="example-translation">(ES: Me gusta el coche. / EN: I like the car.)</span></li>
            </ul>
            <h4><span class="explanation-lang-marker">ES</span>Preposiciones Siempre con Dativo / <span class="explanation-lang-marker">EN</span>Prepositions Always with Dative:</h4>
            <p><strong>aus, bei, mit, nach, seit, von, zu, gegenüber</strong> (Mnemotecnia: "Aus bei mit nach seit von zu...")</p>
            <ul>
                <li><span class="german-verb">aus</span> (de/from): <span class="german-example">Er kommt aus <strong>der Schweiz</strong>.</span> <span class="example-translation">(ES: Él viene de Suiza. / EN: He comes from Switzerland.)</span></li>
                <li><span class="german-verb">mit</span> (con/with): <span class="german-example">Ich spiele mit <strong>meinem Hund</strong>.</span> <span class="example-translation">(ES: Juego con mi perro. / EN: I play with my dog.)</span></li>
                 <li><span class="german-verb">zu</span> (a, hacia/to): <span class="german-example">Sie geht zu <strong>dem Arzt</strong> (zum Arzt).</span> <span class="example-translation">(ES: Ella va al médico. / EN: She goes to the doctor.)</span></li>
            </ul>
            <h4><span class="explanation-lang-marker">ES</span>Artículos en Dativo / <span class="explanation-lang-marker">EN</span>Articles in Dative</h4>
            <table><thead><tr><th>Género/Gender</th><th>Definido/Definite</th><th>Indefinido/Indefinite</th><th>Negación/Negation (kein-)</th></tr></thead><tbody><tr><td>Maskulin (der)</td><td><strong>dem</strong></td><td><strong>einem</strong></td><td><strong>keinem</strong></td></tr><tr><td>Feminin (die)</td><td><strong>der</strong></td><td><strong>einer</strong></td><td><strong>keiner</strong></td></tr><tr><td>Neutrum (das)</td><td><strong>dem</strong></td><td><strong>einem</strong></td><td><strong>keinem</strong></td></tr><tr><td>Plural (die)</td><td><strong>den</strong> (+n*)</td><td>- (keinen*)</td><td><strong>keinen</strong> (+n*)</td></tr></tbody></table>
            <div class="eselsbruecke"><span class="explanation-lang-marker">ES</span>*Nota Dativo Plural: La mayoría de los sustantivos añaden una <strong>-n</strong> en dativo plural si no terminan ya en -n o -s. (ej. die Kinder -> den Kinder<strong>n</strong>)<br><span class="explanation-lang-marker">EN</span>*Dative Plural Note: Most nouns add an <strong>-n</strong> in the dative plural if they don't already end in -n or -s. (e.g., die Kinder -> den Kinder<strong>n</strong>)</div>

            <h3><span class="explanation-lang-marker">ES</span>Preposiciones Duales (Wechselpräpositionen) / <span class="explanation-lang-marker">EN</span>Two-Way Prepositions</h3>
            <p><span class="explanation-lang-marker">ES</span>Estas preposiciones pueden ir con Acusativo O Dativo: <strong>an, auf, hinter, in, neben, über, unter, vor, zwischen</strong>.</p>
            <p><span class="explanation-lang-marker">EN</span>These prepositions can take either Accusative OR Dative: <strong>an, auf, hinter, in, neben, über, unter, vor, zwischen</strong>.</p>
            <ul>
                <li><span class="explanation-lang-marker">ES</span><strong>Acusativo (dirección):</strong> Pregunta "Wohin?" (¿A dónde? - movimiento hacia un destino) <br><span class="german-example">Ich lege das Buch <strong>auf den Tisch</strong>.</span><span class="example-translation">(Pongo el libro sobre la mesa.)</span></li>
                <li><span class="explanation-lang-marker">EN</span><strong>Accusative (direction):</strong> Question "Wohin?" (Where to? - movement to a destination) <br><span class="german-example">Ich lege das Buch <strong>auf den Tisch</strong>.</span><span class="example-translation">(I put the book onto the table.)</span></li>
<br>
                <li><span class="explanation-lang-marker">ES</span><strong>Dativo (lugar):</strong> Pregunta "Wo?" (¿Dónde? - posición, sin movimiento hacia un destino) <br><span class="german-example">Das Buch liegt <strong>auf dem Tisch</strong>.</span><span class="example-translation">(El libro está sobre la mesa.)</span></li>
                <li><span class="explanation-lang-marker">EN</span><strong>Dative (location):</strong> Question "Wo?" (Where? - position, no movement to a destination) <br><span class="german-example">Das Buch liegt <strong>auf dem Tisch</strong>.</span><span class="example-translation">(The book is on the table.)</span></li>
            </ul>
            <h4><span class="explanation-lang-marker">ES</span>Más Ejemplos / <span class="explanation-lang-marker">EN</span>More Examples:</h4>
            <ul>
                <li><span class="german-verb">in:</span>
                    <div class="example-sentence">Akk: Wir gehen <strong>in das Kino</strong> (ins Kino). <span class="example-translation">(ES: Vamos al cine. / EN: We go into the cinema.)</span></div>
                    <div class="example-sentence">Dat: Wir sind <strong>in dem Kino</strong> (im Kino). <span class="example-translation">(ES: Estamos en el cine. / EN: We are in the cinema.)</span></div>
                </li>
            </ul>
            <div class="text-center mt-4">
                <button id="close-introduction-btn" class="btn btn-secondary">Verstanden & Schließen / Entendido & Cerrar</button>
            </div>
        </div>

        <div id="quiz-content-area" class=""> <div id="progress-score-area" class="progress-score-area">
                <span id="progress-text-cases">Frage: 1/10</span>
                <span id="score-text-cases">Punkte: 0</span>
            </div>
            <div id="sentence-display-container" class="sentence-display-container">
                <p id="sentence-german" class="sentence-german">Der Satz wird hier angezeigt... <span class="blank-placeholder"></span>.</p>
                <p id="sentence-translation-en" class="sentence-translation">EN: English translation will appear here.</p>
                <p id="sentence-translation-es" class="sentence-translation">ES: La traducción al español aparecerá aquí.</p>
            </div>

            <div id="options-container" class="options-container">
                </div>
            
            <div id="hint-box" class="feedback-box hidden">
                <h4>Hinweis / Pista:</h4>
                <p id="hint-text-german"></p>
                <p id="hint-text-spanish" class="spanish-explanation"></p>
            </div>

            <div id="explanation-box" class="feedback-box hidden">
                <h4>Erklärung / Explicación:</h4>
                <p id="explanation-text-german" class="german-explanation"></p>
                <p id="explanation-text-spanish" class="spanish-explanation"></p>
                <p id="full-sentence-display" class="mt-2 font-semibold"></p>
            </div>

            <div class="controls-area">
                <button id="hint-btn-cases" class="btn btn-secondary">Hinweis / Pista</button>
                <button id="check-answer-btn-cases" class="btn btn-primary" disabled>Prüfen / Verificar</button>
                <button id="next-question-btn-cases" class="btn btn-primary hidden">Nächste / Siguiente</button>
            </div>
        </div>
        <div class="mt-8 pt-4 border-t border-gray-200 border-opacity-20">
             <a href="index.html" class="btn btn-secondary btn-sm">← Hauptmenü / Menú Principal</a>
        </div>
    </div>

    <script>
        let allCaseSentences = [];
        let currentCaseQuestion = null;
        let currentCaseQuestionIndex = 0;
        let caseTrainerScore = 0;
        let caseTrainerQuestions = []; 
        let userSelectedOptionCases = null;
        let hintUsedForCurrentQuestion = false;

        const toggleIntroductionBtn = document.getElementById('toggle-introduction-btn');
        const introductionPanel = document.getElementById('introduction-panel');
        const closeIntroductionBtn = document.getElementById('close-introduction-btn');
        const quizContentArea = document.getElementById('quiz-content-area');
        const sentenceDisplayContainer = document.getElementById('sentence-display-container');

        const sentenceGermanEl = document.getElementById('sentence-german');
        const sentenceTranslationEnEl = document.getElementById('sentence-translation-en');
        const sentenceTranslationEsEl = document.getElementById('sentence-translation-es');
        const optionsContainerCases = document.getElementById('options-container');
        
        const hintBtnCases = document.getElementById('hint-btn-cases');
        const checkAnswerBtnCases = document.getElementById('check-answer-btn-cases');
        const nextQuestionBtnCases = document.getElementById('next-question-btn-cases');
        
        const hintBoxEl = document.getElementById('hint-box');
        const hintTextGermanEl = document.getElementById('hint-text-german');
        const hintTextSpanishEl = document.getElementById('hint-text-spanish');
        
        const explanationBoxEl = document.getElementById('explanation-box');
        const explanationTextGermanEl = document.getElementById('explanation-text-german');
        const explanationTextSpanishEl = document.getElementById('explanation-text-spanish');
        const fullSentenceDisplayEl = document.getElementById('full-sentence-display');

        const progressTextCasesEl = document.getElementById('progress-text-cases');
        const scoreTextCasesEl = document.getElementById('score-text-cases');

        async function loadCaseData() {
            try {
                const response = await fetch('case_practice.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for case_practice.json`);
                allCaseSentences = await response.json();
                if (allCaseSentences.length === 0) throw new Error("case_practice.json is empty or does not contain valid questions.");
                
                // Start with quiz content visible and intro hidden by default
                introductionPanel.classList.add('hidden');
                quizContentArea.classList.remove('hidden');
                toggleIntroductionBtn.textContent = "Einführung anzeigen / Mostrar Introducción";
                startNewCaseRound(); 
            } catch (error) {
                console.error("Could not load case practice data:", error);
                const mainCard = document.querySelector('.card');
                mainCard.innerHTML = `<h1 class="mode-title text-red-400">Error</h1><p class="text-red-200">Could not load questions: ${error.message}. Please check the console and ensure 'case_practice.json' is available and correctly formatted.</p><a href="index.html" class="btn btn-secondary mt-4">Back to Menu</a>`;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startNewCaseRound() {
            caseTrainerScore = 0;
            currentCaseQuestionIndex = 0;
            shuffleArray(allCaseSentences);
            caseTrainerQuestions = allCaseSentences.slice(0, Math.min(10, allCaseSentences.length)); 
            
            if (caseTrainerQuestions.length === 0) {
                sentenceGermanEl.textContent = "Keine Fragen verfügbar für diese Runde. / No questions available for this round.";
                const existingPrompt = sentenceDisplayContainer.querySelector('.noun-prompt-js');
                if(existingPrompt) existingPrompt.remove();
                sentenceTranslationEnEl.textContent = "";
                sentenceTranslationEsEl.textContent = "";
                optionsContainerCases.innerHTML = '';
                checkAnswerBtnCases.classList.add('hidden');
                hintBtnCases.classList.add('hidden');
                nextQuestionBtnCases.textContent = "Hauptmenü / Main Menu";
                nextQuestionBtnCases.onclick = () => { window.location.href="index.html";};
                nextQuestionBtnCases.classList.remove('hidden');
                quizContentArea.classList.remove('hidden'); 
                introductionPanel.classList.add('hidden');
                return;
            }
            
            displayNextCaseQuestion();
            updateCaseProgressAndScore();
            quizContentArea.classList.remove('hidden'); // Ensure quiz area is visible
            introductionPanel.classList.add('hidden'); // Ensure intro is hidden
            toggleIntroductionBtn.textContent = "Einführung anzeigen / Mostrar Introducción";
        }

        function displayNextCaseQuestion() {
            if (currentCaseQuestionIndex >= caseTrainerQuestions.length) {
                sentenceGermanEl.innerHTML = `Runde beendet! Punktzahl: ${caseTrainerScore} / ${caseTrainerQuestions.length}<br>¡Ronda terminada! Puntuación: ${caseTrainerScore} / ${caseTrainerQuestions.length}`;
                const nounPrompt = sentenceDisplayContainer.querySelector('.noun-prompt-js');
                if(nounPrompt) nounPrompt.remove();
                sentenceTranslationEnEl.textContent = "Round finished! Click 'New Round' to start again.";
                sentenceTranslationEsEl.textContent = "¡Ronda terminada! Haz clic en 'Nueva Ronda' para empezar de nuevo.";
                optionsContainerCases.innerHTML = '';
                hintBtnCases.classList.add('hidden');
                checkAnswerBtnCases.classList.add('hidden');
                nextQuestionBtnCases.textContent = "Neue Runde / Nueva Ronda";
                nextQuestionBtnCases.classList.remove('hidden');
                nextQuestionBtnCases.onclick = startNewCaseRound;
                hintBoxEl.classList.add('hidden');
                explanationBoxEl.classList.add('hidden');
                return;
            }

            currentCaseQuestion = caseTrainerQuestions[currentCaseQuestionIndex];
            userSelectedOptionCases = null;
            hintUsedForCurrentQuestion = false;

            const sentenceParts = currentCaseQuestion.sentence_de_template.split('___');
            sentenceGermanEl.innerHTML = `${sentenceParts[0]}<span class="blank-placeholder"></span>${sentenceParts[1] || ''}`;
            
            const existingPrompt = sentenceDisplayContainer.querySelector('.noun-prompt-js');
            if(existingPrompt) existingPrompt.remove();
            
            const nounPromptEl = document.createElement('p');
            nounPromptEl.classList.add('noun-prompt-js'); 
            nounPromptEl.innerHTML = `Setze ein / Insert / Inserta: <strong>${currentCaseQuestion.target_noun_info.nominativ_form}</strong> (${currentCaseQuestion.target_noun_info.gender})`;
            sentenceDisplayContainer.insertBefore(nounPromptEl, sentenceTranslationEnEl); 

            sentenceTranslationEnEl.textContent = `EN: ${currentCaseQuestion.translation_en}`;
            sentenceTranslationEsEl.textContent = `ES: ${currentCaseQuestion.translation_es}`;

            optionsContainerCases.innerHTML = '';
            currentCaseQuestion.options.forEach((optionText, index) => {
                const optionButton = document.createElement('button');
                optionButton.classList.add('option-btn');
                optionButton.textContent = optionText;
                optionButton.dataset.optionIndex = index;
                optionButton.onclick = () => handleCaseOptionClick(optionButton, optionText);
                optionsContainerCases.appendChild(optionButton);
            });

            hintBoxEl.classList.add('hidden');
            explanationBoxEl.classList.add('hidden');
            hintBtnCases.classList.remove('hidden');
            hintBtnCases.disabled = false;
            checkAnswerBtnCases.disabled = true; 
            nextQuestionBtnCases.classList.add('hidden');
            nextQuestionBtnCases.textContent = "Nächste / Siguiente"; 
             nextQuestionBtnCases.onclick = () => { 
                currentCaseQuestionIndex++; 
                displayNextCaseQuestion();
            }; 

            updateCaseProgressAndScore();
        }

        function handleCaseOptionClick(buttonEl, optionText) {
            const currentlySelected = optionsContainerCases.querySelector('.option-btn.selected');
            if (currentlySelected) {
                currentlySelected.classList.remove('selected');
            }
            buttonEl.classList.add('selected');
            userSelectedOptionCases = optionText;
            checkAnswerBtnCases.disabled = false;
        }

        hintBtnCases.addEventListener('click', () => {
            if (!currentCaseQuestion || hintUsedForCurrentQuestion) return;
            hintTextGermanEl.textContent = currentCaseQuestion.hint_de;
            hintTextSpanishEl.textContent = currentCaseQuestion.hint_es;
            hintBoxEl.classList.remove('hidden');
            explanationBoxEl.classList.add('hidden'); 
            hintBtnCases.disabled = true;
            hintUsedForCurrentQuestion = true;
        });

        checkAnswerBtnCases.addEventListener('click', () => {
            if (!userSelectedOptionCases || !currentCaseQuestion) return;

            const isCorrect = userSelectedOptionCases === currentCaseQuestion.correct_option_text;
            
            optionsContainerCases.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true; 
                if (btn.textContent === currentCaseQuestion.correct_option_text) {
                    btn.classList.add('correct');
                } else if (btn.textContent === userSelectedOptionCases && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                caseTrainerScore++;
                if(typeof confetti === 'function') confetti({ particleCount: 80, spread: 70, origin: {y: 0.6}});
            }
            
            explanationTextGermanEl.textContent = currentCaseQuestion.explanation_de;
            explanationTextSpanishEl.textContent = currentCaseQuestion.explanation_es;
            fullSentenceDisplayEl.textContent = `DE: ${currentCaseQuestion.full_correct_sentence_de}`;
            explanationBoxEl.classList.remove('hidden');
            hintBoxEl.classList.add('hidden'); 

            checkAnswerBtnCases.classList.add('hidden');
            hintBtnCases.classList.add('hidden');
            nextQuestionBtnCases.classList.remove('hidden');
            updateCaseProgressAndScore(); 
        });
        
        nextQuestionBtnCases.addEventListener('click', () => { 
            displayNextCaseQuestion(); 
        });


        function updateCaseProgressAndScore() {
            if (caseTrainerQuestions.length > 0) {
                 progressTextCasesEl.textContent = `Frage: ${Math.min(currentCaseQuestionIndex + 1, caseTrainerQuestions.length)}/${caseTrainerQuestions.length}`;
            } else {
                 progressTextCasesEl.textContent = `Frage: 0/0`;
            }
            scoreTextCasesEl.textContent = `Punkte: ${caseTrainerScore}`;
        }

        toggleIntroductionBtn.addEventListener('click', () => {
            const introIsHidden = introductionPanel.classList.toggle('hidden');
            quizContentArea.classList.toggle('hidden', !introIsHidden);
            if (introIsHidden) { // Intro is now hidden, quiz should be visible
                toggleIntroductionBtn.textContent = "Einführung anzeigen / Mostrar Introducción";
                // If quiz hasn't effectively started (no questions in current round yet) but data is loaded
                if (caseTrainerQuestions.length === 0 && allCaseSentences.length > 0) {
                    startNewCaseRound();
                }
            } else { // Intro is now visible, quiz should be hidden
                toggleIntroductionBtn.textContent = "Einführung schließen / Cerrar Introducción";
            }
        });
        closeIntroductionBtn.addEventListener('click', () => {
            introductionPanel.classList.add('hidden');
            quizContentArea.classList.remove('hidden');
            toggleIntroductionBtn.textContent = "Einführung anzeigen / Mostrar Introducción";
            if (caseTrainerQuestions.length === 0 && allCaseSentences.length > 0) { 
                 startNewCaseRound();
            }
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', loadCaseData);
    </script>
</body>
</html>
