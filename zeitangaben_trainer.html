<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Deutsche Zeitw√∂rter Quiz (Tage, Monate, Zeiten)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff;
            background-image: linear-gradient(to right top, #283cd9, #5c6cf6, #8b9bfa, #b9cafa, #e3f2fe);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 16px;
            color: #374151;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            width: 100%;
            max-width: 700px;
            position: relative;
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-top: 8px;
        }
         .btn-link { /* For the back to menu button */
            display: inline-block;
            text-decoration: none;
        }
        .btn:disabled {
            background-color: #d1d5db !important;
            color: #6b7280 !important;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary { background-color: #6d28d9; }
        .btn-primary:hover:not(:disabled) { background-color: #5b21b6; }
        .btn-secondary { background-color: #4f46e5; }
        .btn-secondary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-success { background-color: #059669; }
        .btn-success:hover:not(:disabled) { background-color: #047857; }
        .btn-danger { background-color: #be123c; } 
        .btn-danger:hover:not(:disabled) { background-color: #9f1239; }
        .btn-choice { background-color: #1d4ed8; }
        .btn-choice:hover:not(:disabled) { background-color: #1e40af; }
        #question-display{font-size:2rem;font-weight:700;color:#4a044e;margin-bottom:0.5rem;}
        #multilang-translation-display {font-size: 1rem; color: #4b5563; font-style: italic; margin-top: 0.5rem; margin-bottom: 1rem; min-height: 40px; }
        #hint-display{font-size:0.9rem;color:#6b7280;margin-bottom:2rem;min-height:40px; line-height: 1.4;}
        #choices-container{display:flex;flex-wrap:wrap;justify-content:center;gap:16px}.mode-selection{display:flex;gap:16px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}.mode-btn{padding:16px 24px;font-size:1.1rem;border-radius:12px;min-width:200px}kbd{font-family:monospace;background-color:#e2e8f0;color:#4a5568;padding:3px 6px;border-radius:4px;border:1px solid #cbd5e0;font-size:.85em;box-shadow:1px 1px 1px rgba(0,0,0,.1)}@media (max-width:768px){#question-display{font-size:1.8rem}}@media (max-width:640px){.card{padding:20px}.btn{padding:10px 16px;font-size:.9rem}#question-display{font-size:1.5rem}}
    </style>
</head>
<body>
    <div id="main-container" class="card">
        <div id="mode-selection-screen" class="">
            <button id="settings-btn" title="Einstellungen">‚öôÔ∏è</button>
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6 text-center">Deutsche Zeitw√∂rter Quiz</h1>
            <div class="mode-selection">
                <button id="quiz-mode-btn" class="btn btn-primary mode-btn">
                    üìù Lern-Quiz
                    <div class="text-sm opacity-90 mt-1">Lerne Tage, Monate und Zeiten</div>
                </button>
            </div>
            <p id="quiz-summary" class="text-sm text-gray-500 mt-4"></p>
            <div class="mt-8 pt-6 border-t border-gray-200">
                <a href="index.html" class="btn btn-secondary btn-link">‚Üê Zur√ºck zum Hauptmen√º</a>
            </div>
        </div>

        <div id="quiz-mode-screen" class="hidden">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6 text-center">Frage</h1>
            <div id="question-area" class="mb-6">
                 <p id="question-display" class="text-center" style="min-height: 60px;"></p>
                 <div id="multilang-translation-display"></div>
                 <div id="hint-display" class="text-center"></div>
            </div>
            <div id="choices-container" class="mb-6"></div>
            <div id="feedback-area" class="feedback-area hidden"></div>
            <div id="detailed-results-list" class="detailed-results-list hidden"></div>
            <div id="quiz-controls-area" class="text-center mt-4">
                <button id="restart-quiz-btn" class="btn btn-secondary hidden">Quiz neu starten</button>
                <button id="back-to-menu-btn" class="btn btn-secondary mr-2">Quiz-Men√º</button>
                <a href="index.html" class="btn btn-secondary btn-link">Hauptmen√º</a>
            </div>
            <div id="progress-indicator" class="progress-text mt-4 text-center">Frage 0 / 0</div>
            <div id="score-indicator" class="progress-text mt-1 text-center">Punkte: 0 / 0</div>
        </div>
    </div>
    
    <div id="settings-overlay" class="hidden">
        <div id="settings-modal-content">
            <div>
                <h2 class="settings-title">Einstellungen</h2>
                <p class="settings-subtitle">Settings</p>
            </div>
            <div class="settings-content-area">
                <div class="settings-section">
                    <h3>Anzahl der Fragen</h3>
                    <p class="translation">Number of Questions</p>
                    <div class="flex items-center gap-4">
                        <input type="range" id="num-questions-slider" min="10" value="20" class="w-full">
                        <span id="num-questions-value" class="font-bold text-purple-700 w-12 text-center">20</span>
                         <label class="checkbox-label whitespace-nowrap"><input type="checkbox" id="all-questions-checkbox"> Alle <span class="text-sm text-gray-500 ml-1">/ All</span></label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Kategorien</h3>
                    <p class="translation">Categories</p>
                    <div id="category-checkboxes"></div>
                </div>
            </div>
            <div class="settings-footer">
                <button id="save-settings-btn" class="btn btn-primary w-full">Speichern & Schlie√üen</button>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let userAnswers = [];
        let quizSettings = {};
        let currentQuestionIndex, score, shuffledQuestions, answerSelected, autoAdvanceTimeout;

        const elements = {
            mainContainer: document.getElementById("main-container"),
            backToMenuBtn: document.getElementById("back-to-menu-btn"),
            choicesContainerEl: document.getElementById("choices-container"),
            detailedResultsListEl: document.getElementById("detailed-results-list"),
            feedbackAreaEl: document.getElementById("feedback-area"),
            questionDisplayEl: document.getElementById("question-display"),
            multilangTranslationDisplayEl: document.getElementById("multilang-translation-display"),
            hintDisplayEl: document.getElementById("hint-display"),
            progressIndicatorEl: document.getElementById("progress-indicator"),
            quizModeBtn: document.getElementById("quiz-mode-btn"),
            quizModeScreen: document.getElementById("quiz-mode-screen"),
            restartQuizBtn: document.getElementById("restart-quiz-btn"),
            scoreIndicatorEl: document.getElementById("score-indicator"),
            settingsBtn: document.getElementById("settings-btn"),
            settingsOverlay: document.getElementById("settings-overlay"),
            saveSettingsBtn: document.getElementById("save-settings-btn"),
            numQuestionsSlider: document.getElementById("num-questions-slider"),
            numQuestionsValue: document.getElementById("num-questions-value"),
            allQuestionsCheckbox: document.getElementById("all-questions-checkbox"),
            categoryCheckboxesContainer: document.getElementById("category-checkboxes"),
            quizSummaryEl: document.getElementById("quiz-summary"),
            questionArea: document.getElementById("question-area")
        };
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function triggerConfetti() { if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        
        function clearAutoAdvance(timeoutVar) { clearTimeout(timeoutVar); }

        function loadSettings() {
            const savedSettings = localStorage.getItem('timeQuizSettingsV2');
            const defaultSettings = { numQuestions: 20, useAllQuestions: false, categories: ['Wochentage'] };
            quizSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            updateQuizSummary();
        }

        function saveSettings() {
            localStorage.setItem('timeQuizSettingsV2', JSON.stringify(quizSettings));
            updateQuizSummary();
        }
        
        function openSettings() {
            elements.numQuestionsSlider.value = quizSettings.numQuestions;
            elements.numQuestionsValue.textContent = quizSettings.numQuestions;
            elements.allQuestionsCheckbox.checked = quizSettings.useAllQuestions;
            elements.numQuestionsSlider.disabled = quizSettings.useAllQuestions;
            
            const availableCats = [...elements.categoryCheckboxesContainer.querySelectorAll('input[type="checkbox"]')];
            availableCats.forEach(cb => {
                cb.checked = quizSettings.categories.includes(cb.value);
            });
            elements.settingsOverlay.classList.remove('hidden');
        }

        function handleSaveSettings() {
            quizSettings.useAllQuestions = elements.allQuestionsCheckbox.checked;
            if (!quizSettings.useAllQuestions) {
                quizSettings.numQuestions = parseInt(elements.numQuestionsSlider.value, 10);
            }
            
            let selectedCategories = [...elements.categoryCheckboxesContainer.querySelectorAll('input:checked')].map(cb => cb.value);

            if(selectedCategories.length === 0) {
                alert("Bitte w√§hle mindestens eine Kategorie aus.");
                return;
            }
            
            quizSettings.categories = selectedCategories;
            
            saveSettings();
            elements.settingsOverlay.classList.add('hidden');
            showQuizMode(); // Quiz mit neuen Einstellungen neu starten
        }

        function populateCategoryCheckboxes() {
            const categories = [...new Set(allQuestions.map(n => n.category))].sort();
            let checkboxesHTML = '';
            categories.forEach(cat => {
                checkboxesHTML += `<label class="checkbox-label"><input type="checkbox" value="${cat}"> ${cat}</label>`;
            });
            elements.categoryCheckboxesContainer.innerHTML = checkboxesHTML;
        }
        
        function updateQuizSummary() {
            const numText = quizSettings.useAllQuestions ? `Alle (${getFilteredQuestions(false).length})` : quizSettings.numQuestions;
            const catText = `${quizSettings.categories.length} Kategorien`;
            elements.quizSummaryEl.textContent = `Aktuell: ${numText} Fragen aus ${catText}. √Ñndere dies in den Einstellungen (‚öôÔ∏è).`;
        }

        async function loadQuizData() {
            try {
                const response = await fetch('zeitangaben.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allQuestions = await response.json();
            } catch (error) {
                console.error("Could not load quiz data:", error);
                elements.mainContainer.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Fehler beim Laden</h1><p class="mb-2">Quizdaten (german_time.json) nicht gefunden oder fehlerhaft.</p><p class="text-sm text-gray-700 mb-4">Details: ${error.message}</p><p class="text-xs text-gray-500">Stellen Sie sicher, dass die Datei 'german_time.json' im selben Verzeichnis wie die HTML-Datei liegt.</p><button onclick="location.reload()" class="btn btn-primary mt-4">Neu laden</button></div>`;
                throw new Error("Failed to load quiz data. Halting execution.");
            }
        }
        
        function getFilteredQuestions(shuffle = true) {
            let filtered = allQuestions.filter(q => quizSettings.categories.includes(q.category));
            if (shuffle) shuffleArray(filtered);
            return quizSettings.useAllQuestions ? filtered : filtered.slice(0, quizSettings.numQuestions);
        }

        function showModeSelection() {
            updateQuizSummary();
            document.getElementById('mode-selection-screen').classList.remove('hidden');
            elements.quizModeScreen.classList.add('hidden');
        }
        
        function showQuizMode() {
            document.getElementById('mode-selection-screen').classList.add('hidden');
            elements.quizModeScreen.classList.remove('hidden');
            startQuiz();
        }

        function startQuiz() {
            shuffledQuestions = getFilteredQuestions();
            if (shuffledQuestions.length === 0) {
                alert("F√ºr die gew√§hlten Kategorien wurden keine Fragen gefunden. Bitte w√§hle andere Kategorien in den Einstellungen.");
                showModeSelection();
                return;
            }
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            elements.detailedResultsListEl.classList.add('hidden');
            clearAutoAdvance(autoAdvanceTimeout);
            elements.feedbackAreaEl.className = "feedback-area hidden";
            elements.restartQuizBtn.classList.add('hidden');
            elements.questionArea.classList.remove("hidden");
            elements.choicesContainerEl.classList.remove("hidden");
            loadQuestion();
        }

        function loadQuestion() {
            answerSelected = false;
            clearAutoAdvance(autoAdvanceTimeout);
            if (currentQuestionIndex < shuffledQuestions.length) {
                const question = shuffledQuestions[currentQuestionIndex];
                elements.questionDisplayEl.textContent = question.question;
                
                // HIER IST DIE NEUE LOGIK F√úR MEHRSPRACHIGE HINTS
                const translationContainer = elements.multilangTranslationDisplayEl;
                translationContainer.innerHTML = '';
                if (question.en_translation || question.es_mx_translation) {
                    translationContainer.innerHTML = `
                        <span class="block">${question.en_translation || ''}</span>
                        <span class="block">${question.es_mx_translation || ''}</span>
                    `;
                }
                
                const hintContainer = elements.hintDisplayEl;
                hintContainer.innerHTML = '';
                if (question.hint && question.hint.de) {
                    hintContainer.innerHTML = `
                        <span class="block font-semibold">${question.hint.de}</span>
                        <span class="block text-xs text-gray-500">${question.hint.en}</span>
                        <span class="block text-xs text-gray-500">${question.hint.es_mx}</span>
                    `;
                }
                
                elements.feedbackAreaEl.className = "feedback-area hidden";

                const choices = shuffleArray([...question.distractors, question.answer]);
                elements.choicesContainerEl.innerHTML = '';
                choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice;
                    button.className = 'btn btn-choice';
                    button.onclick = () => handleAnswer(choice);
                    elements.choicesContainerEl.appendChild(button);
                });
                
                updateProgress();
            } else {
                showResults();
            }
        }
        
        function handleAnswer(selectedAnswer) {
            if (answerSelected) return;
            answerSelected = true;
            const question = shuffledQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.answer; 
            userAnswers.push({ question: JSON.parse(JSON.stringify(question)), userAnswer: selectedAnswer, isCorrect: isCorrect }); 
            elements.feedbackAreaEl.classList.remove("hidden"); 
            if (isCorrect) { 
                score++; 
                elements.feedbackAreaEl.innerHTML = `Richtig! <span class="correct-answer-text">${question.answer}</span>`; 
                elements.feedbackAreaEl.className = "feedback-area correct"; 
                triggerConfetti(); 
            } else { 
                elements.feedbackAreaEl.innerHTML = `Falsch. Richtig ist: <span class="correct-answer-text">${question.answer}</span>`; 
                elements.feedbackAreaEl.className = "feedback-area incorrect"; 
            } 
            const buttons = elements.choicesContainerEl.querySelectorAll('button'); 
            buttons.forEach(btn => { 
                btn.disabled = true; 
                const isSelectedButton = btn.textContent === selectedAnswer; 
                const isCorrectButton = btn.textContent === question.answer; 
                if (isSelectedButton) { 
                    btn.classList.add(isCorrect ? "bg-green-600" : "bg-red-600"); 
                } else if (isCorrectButton) { 
                    btn.classList.add("bg-green-400"); 
                } else { 
                    btn.classList.add("opacity-50"); 
                } 
            }); 
            updateProgress(); 
            currentQuestionIndex++; 
            autoAdvanceTimeout = setTimeout( currentQuestionIndex < shuffledQuestions.length ? loadQuestion : showResults, 2500 ); 
        }

        function updateProgress() {
            elements.progressIndicatorEl.textContent = `Frage: ${Math.min(currentQuestionIndex + 1, shuffledQuestions.length)} / ${shuffledQuestions.length}`;
            elements.scoreIndicatorEl.textContent = `Punkte: ${score} / ${userAnswers.length}`;
        }
        
        function showResults() {
            clearAutoAdvance(autoAdvanceTimeout);
            elements.questionArea.classList.add("hidden");
            elements.choicesContainerEl.classList.add("hidden");
            elements.feedbackAreaEl.classList.remove("hidden");
            elements.feedbackAreaEl.className = "feedback-area correct";
            const questionsAnswered = userAnswers.length;
            elements.feedbackAreaEl.innerHTML = `Quiz beendet! Endergebnis: <strong class="text-2xl">${score}</strong> / ${questionsAnswered}`;
            let resultsHTML = `<h3>Deine Antworten im Detail:</h3><ul>`;
            userAnswers.forEach(ans => {
                resultsHTML += `<li class="${ans.isCorrect ? "result-correct" : "result-incorrect"}">`;
                resultsHTML += `<strong>Frage:</strong> "${ans.question.question}"<br>`;
                if (ans.isCorrect) {
                    resultsHTML += `<span class="text-green-700 font-semibold">Richtig als "${ans.userAnswer}"</span>`;
                } else {
                    resultsHTML += `<span class="text-red-700">Du: "${ans.userAnswer}". Richtig:</span> <strong class="text-blue-600">"${ans.question.answer}"</strong>.`;
                }
                resultsHTML += `</li>`;
            });
            resultsHTML += "</ul>";
            elements.detailedResultsListEl.innerHTML = resultsHTML;
            elements.detailedResultsListEl.classList.remove("hidden");
            elements.progressIndicatorEl.textContent = "Quiz beendet!";
            elements.scoreIndicatorEl.textContent = `Endstand: ${score} / ${questionsAnswered}`;
            elements.restartQuizBtn.classList.remove("hidden");
        }
        
        async function initialSetup() {
            elements.quizModeBtn.disabled = true;
            elements.settingsBtn.disabled = true;
            const loadingMsg = document.createElement('p');
            loadingMsg.id = 'loading-msg';
            loadingMsg.textContent = "Lade Quizdaten...";
            loadingMsg.className = 'text-lg text-gray-600 my-4';
            document.getElementById('mode-selection-screen').querySelector('.mode-selection').insertAdjacentElement('beforebegin', loadingMsg);
            
            await loadQuizData();
            
            const msg = document.getElementById('loading-msg');
            if (msg) msg.remove();
            
            elements.numQuestionsSlider.max = allQuestions.length;
            populateCategoryCheckboxes();
            loadSettings();

            elements.quizModeBtn.disabled = false;
            elements.settingsBtn.disabled = false;
            showModeSelection();
        }
        
        elements.quizModeBtn.addEventListener("click", showQuizMode);
        elements.restartQuizBtn.addEventListener("click", startQuiz);
        elements.backToMenuBtn.addEventListener("click", showModeSelection);
        elements.settingsBtn.addEventListener("click", openSettings);
        elements.saveSettingsBtn.addEventListener("click", handleSaveSettings);
        elements.numQuestionsSlider.addEventListener("input", e => { elements.numQuestionsValue.textContent = e.target.value });
        elements.allQuestionsCheckbox.addEventListener("change", e => { elements.numQuestionsSlider.disabled = e.target.checked });
        
        initialSetup();
    </script>
</body>
</html>
