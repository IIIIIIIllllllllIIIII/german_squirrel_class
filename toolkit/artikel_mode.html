<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Deutsche Artikel Quiz (Der, Die, Das)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff;
            background-image: linear-gradient(to right top, #d928a9, #f65ce0, #fa8bf5, #fdb5fa, #fed6fe);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 16px;
            color: #374151;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            width: 100%;
            max-width: 700px;
            position: relative;
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-top: 8px;
        }
        .btn-link { /* For the back to menu button */
            display: inline-block;
            text-decoration: none;
        }
        .btn:disabled {
            background-color: #d1d5db !important;
            color: #6b7280 !important;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary { background-color: #6d28d9; }
        .btn-primary:hover:not(:disabled) { background-color: #5b21b6; }
        .btn-secondary { background-color: #4f46e5; }
        .btn-secondary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-success { background-color: #059669; }
        .btn-success:hover:not(:disabled) { background-color: #047857; }
        .btn-danger { background-color: #be123c; } 
        .btn-danger:hover:not(:disabled) { background-color: #9f1239; }

        /* --- Settings Panel Styles --- */
        #settings-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.3s;
            z-index: 10;
        }
        #settings-btn:hover { color: #4b5563; }
        #settings-overlay {
             position: fixed;
             inset: 0;
             background-color: rgba(0, 0, 0, 0.5);
             backdrop-filter: blur(4px);
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 1rem;
             z-index: 50;
        }
        #settings-modal-content {
             background-color: white;
             border-radius: 12px;
             padding: 24px;
             width: 100%;
             max-width: 500px;
             max-height: 90vh;
             display: flex;
             flex-direction: column;
             text-align: left;
             box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .settings-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a044e;
            margin-bottom: 4px;
        }
        .settings-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 24px;
        }
        .settings-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 8px; /* For scrollbar */
        }
        .settings-section { margin-bottom: 24px; }
        .settings-section h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 2px; color: #4a044e; }
        .settings-section .translation { font-size: 0.8rem; color: #6b7280; margin-bottom: 12px;}
        #category-checkboxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 6px; transition: background-color 0.2s; user-select: none; }
        .checkbox-label:hover { background-color: #f3f4f6; }
        .checkbox-label input { margin-right: 10px; width: 1.1em; height: 1.1em; accent-color: #6d28d9; }
        .settings-footer { margin-top: auto; padding-top: 1rem; }
        .settings-footer .translation { font-size: 0.8rem; color: #6b7280; margin-top: 4px; text-align: center; }

        /* --- Dark Mode Styles for Settings --- */
        @media (prefers-color-scheme: dark) {
            #settings-modal-content { background-color: #1f2937; color: #d1d5db; }
            .settings-title, .settings-section h3 { color: #a78bfa; }
            .settings-subtitle, .settings-section .translation, .settings-footer .translation { color: #9ca3af; }
            .checkbox-label { color: #d1d5db; }
            .checkbox-label:hover { background-color: #374151; }
            #settings-btn { color: #6b7280; }
            #settings-btn:hover { color: #d1d5db; }
        }
        .artikel-option-btn{padding:18px 12px;font-size:1.2rem;line-height:1.3;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80px;flex-basis:calc(33.333% - 12px);min-width:120px;word-break:break-word}.btn-der{background-color:#2563eb}.btn-der:hover:not(:disabled){background-color:#1d4ed8}.btn-die{background-color:#dc2626}.btn-die:hover:not(:disabled){background-color:#b91c1c}.btn-das{background-color:#16a34a}.btn-das:hover:not(:disabled){background-color:#15803d}.speed-round-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:20px;text-align:center;min-height:400px;display:flex;flex-direction:column;justify-content:center}.speed-round-word{font-size:4rem;font-weight:800;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.3)}.speed-round-meaning{font-size:1.5rem;margin:10px 0;opacity:.9}.timer-bar{width:100%;height:8px;background-color:rgba(255,255,255,.3);border-radius:4px;overflow:hidden;margin:20px 0}.timer-fill{height:100%;background-color:#10b981;transition:width .1s linear;border-radius:4px}.feedback-area{font-size:.95rem;font-weight:500;padding:12px;border-radius:8px;min-height:60px;margin-bottom:1rem;text-align:center}.feedback-area.correct{color:#065f46;background-color:#dcfce7;border:1px solid #bbf7d0;display:block!important}.feedback-area.incorrect{color:#b91c1c;background-color:#fee2e2;border:1px solid #fecaca;display:block!important}.feedback-area .correct-answer-text,.feedback-area strong{font-weight:700}.detailed-results-list{margin-top:1rem;text-align:left;max-height:200px;overflow-y:auto;padding:.75rem;border:1px solid #e5e7eb;border-radius:8px;background-color:#f9fafb}.detailed-results-list h3{font-size:1.125rem;font-weight:600;margin-bottom:.75rem}.detailed-results-list ul{list-style:none;padding:0}.detailed-results-list li{margin-bottom:.75rem;padding:.5rem;border-radius:6px;font-size:.875rem}.result-correct{background-color:#ecfdf5;border-left:4px solid #10b981}.result-incorrect{background-color:#fff1f2;border-left:4px solid #f43f5e}.progress-text{margin-top:12px;font-size:.875rem;color:#6b7280}.hidden{display:none!important}#noun-display{font-size:2.5rem;font-weight:700;color:#4a044e;margin-bottom:.5rem}#translation-display{font-size:1rem;color:#6b7280;font-style:italic;margin-bottom:2rem;min-height:40px}#artikel-choices-container{display:flex;flex-wrap:wrap;justify-content:center;gap:16px}.mode-selection{display:flex;gap:16px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}.mode-btn{padding:16px 24px;font-size:1.1rem;border-radius:12px;min-width:200px}kbd{font-family:monospace;background-color:#e2e8f0;color:#4a5568;padding:3px 6px;border-radius:4px;border:1px solid #cbd5e0;font-size:.85em;box-shadow:1px 1px 1px rgba(0,0,0,.1)}@media (max-width:768px){#artikel-choices-container .btn{flex-basis:calc(33.333% - 10px);font-size:1.1rem}.mode-selection{flex-direction:column;align-items:center}.speed-round-word{font-size:3rem}#noun-display{font-size:2rem}.detailed-results-list{max-height:180px}}@media (max-width:640px){.card{padding:20px}.btn{padding:10px 16px;font-size:.9rem}.artikel-option-btn{font-size:1rem;min-height:70px}#noun-display{font-size:1.8rem}.feedback-area{font-size:.9rem;min-height:50px}#artikel-choices-container .btn{flex-basis:calc(100% - 8px);min-width:100px}.speed-round-word{font-size:2.5rem}.speed-round-meaning{font-size:1.2rem}.detailed-results-list{max-height:150px;font-size:.8rem}.detailed-results-list li{font-size:.8rem}}
    </style>
</head>
<body>
    <div id="main-container" class="card">
        <div id="mode-selection-screen" class="">
            <button id="settings-btn" title="Einstellungen / Settings / Ajustes">‚öôÔ∏è</button>
            <h1 class="text-2xl sm:text-3xl font-bold text-purple-700 mb-6 text-center">Deutsche Nomen Artikel</h1>
            <div class="mode-selection">
                <button id="quiz-mode-btn" class="btn btn-primary mode-btn">
                    üìù Der/Die/Das Quiz
                    <div class="text-sm opacity-90 mt-1">Asignar los art√≠culos correctos a los sustantivos respectivos</div>
                </button>
                <button id="speed-mode-btn" class="btn btn-success mode-btn">
                    ‚ö° Speed Learning
                    <div class="text-sm opacity-90 mt-1">Cuestionario a tiempo</div>
                </button>
            </div>
            <p id="quiz-summary" class="text-sm text-gray-500 mt-4"></p>
            <p class="text-xs text-gray-400 mt-6 italic">
                Note: The number of nouns and categories for the quizzes can be chosen in the settings (‚öôÔ∏è).
                <br>
                Nota: El n√∫mero de sustantivos y las categor√≠as para los cuestionarios se pueden elegir en la configuraci√≥n (‚öôÔ∏è).
            </p>
            <div class="mt-8 pt-6 border-t border-gray-200">
                <a href="index.html" class="btn btn-secondary btn-link">‚Üê Back to Main Menu</a>
           </div>
        </div>

        <div id="quiz-mode-screen" class="hidden">
            <h1 class="text-2xl sm:text-3xl font-bold text-purple-700 mb-6 text-center">Der, Die, oder Das?</h1>
            <div id="question-area" class="mb-6">
                 <p id="noun-display" class="text-center" style="min-height: 60px;"></p>
                 <p id="translation-display" class="text-center"></p>
            </div>
            <div id="artikel-choices-container" class="mb-6">
                <button id="der-btn" class="btn artikel-option-btn btn-der" data-artikel="der">DER</button>
                <button id="die-btn" class="btn artikel-option-btn btn-die" data-artikel="die">DIE</button>
                <button id="das-btn" class="btn artikel-option-btn btn-das" data-artikel="das">DAS</button>
            </div>
            <div id="feedback-area" class="feedback-area hidden"></div>
            <div id="detailed-results-list" class="detailed-results-list hidden"></div>
            <div id="quiz-controls-area" class="text-center mt-4">
                <button id="end-quiz-btn" class="btn btn-danger mr-2 hidden">Quiz beenden</button>
                <button id="restart-quiz-btn" class="btn btn-secondary hidden">Quiz neu starten</button>
                <button id="back-to-menu-btn" class="btn btn-secondary">Zur√ºck zum Men√º</button>
            </div>
            <div id="progress-indicator" class="progress-text mt-4 text-center">Frage 0 / 0</div>
            <div id="score-indicator" class="progress-text mt-1 text-center">Punkte: 0 / 0</div>
            <div id="hint-area" class="progress-text mt-3 text-center hidden"></div>
        </div>

        <div id="speed-mode-screen" class="hidden">
            <div id="speed-round-container" class="speed-round-card">
                <div id="speed-question-text" class="text-xl mb-4 opacity-90">Welcher Artikel?</div>
                <div id="speed-word-de" class="speed-round-word text-yellow-200">Haus</div>
                <div id="speed-word-trans" class="speed-round-meaning text-yellow-100">House / Casa</div>
                <div class="timer-bar"><div id="timer-fill" class="timer-fill" style="width: 100%;"></div></div>
                <div id="speed-choices" class="grid grid-cols-3 gap-4 mt-6 mb-4"></div>
                <div id="speed-feedback" class="text-lg font-bold mb-4 hidden"></div>
                <div id="speed-progress" class="text-lg opacity-90">1 / 100</div>
                <div id="speed-controls" class="mt-6 flex justify-center items-center">
                     <button id="speed-pause-btn" class="btn btn-secondary">‚è∏Ô∏è Pause</button>
                     <button id="end-speed-btn" class="btn btn-danger mx-2">Runde beenden</button>
                     <button id="speed-back-to-menu-btn-ingame" class="btn btn-secondary">Zur√ºck</button>
                </div>
            </div>
            <div id="speed-complete" class="hidden text-center">
                <h2 class="text-2xl font-bold text-green-600 mb-4">üéâ Runde beendet!</h2>
                <p class="text-lg mb-2">Du hast <span id="speed-total-qs">0</span> Fragen beantwortet!</p>
                <p class="text-xl font-bold text-purple-600 mb-6">Endstand: <span id="speed-final-score">0</span> / <span id="speed-final-total">0</span></p>
                <div id="speed-detailed-results-list" class="detailed-results-list hidden text-left mx-auto max-w-md mb-4"></div>
                <button id="speed-restart-btn" class="btn btn-success mr-4">üîÑ Neu starten</button>
                <button id="speed-back-to-menu-btn" class="btn btn-secondary">Zur√ºck zum Men√º</button>
            </div>
        </div>
    </div>
    
    <div id="settings-overlay" class="hidden">
        <div id="settings-modal-content">
            <div>
                <h2 class="settings-title">Einstellungen</h2>
                <p class="settings-subtitle">Settings / Ajustes</p>
            </div>
            <div class="settings-content-area">
                <div class="settings-section">
                    <h3>Anzahl der Fragen</h3>
                    <p class="translation">Number of Questions / N√∫mero de Preguntas</p>
                    <div class="flex items-center gap-4">
                        <input type="range" id="num-questions-slider" min="5" value="20" class="w-full">
                        <span id="num-questions-value" class="font-bold text-purple-700 w-12 text-center">20</span>
                         <label class="checkbox-label whitespace-nowrap"><input type="checkbox" id="all-questions-checkbox"> Alle <span class="text-sm text-gray-500 ml-1">/ All</span></label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Kategorien</h3>
                    <p class="translation">Categories / Categor√≠as</p>
                    <div id="category-checkboxes">
                        </div>
                </div>
            </div>
            <div class="settings-footer">
                <button id="save-settings-btn" class="btn btn-primary w-full">Speichern & Schlie√üen</button>
                <div class="translation">Save & Close / Guardar y Cerrar</div>
            </div>
        </div>
    </div>

    <script>
       // --- Global Variables ---
       let allNouns = [];
       let derDieDasUserAnswers = [];
       let speedRoundUserAnswers = [];
       let quizSettings = {};

       // --- Quiz State Variables ---
       let currentQuestionIndex, score, shuffledQuestions, answerSelected, autoAdvanceTimeout;
       let speedCurrentIndex, speedInterval, speedPaused, speedQuestions, speedScore, speedAnswered;
       const speedTimePerCard = 5000;

       // --- Element Caching ---
       const backToMenuBtn = document.getElementById("back-to-menu-btn"),
            choicesContainerEl = document.getElementById("artikel-choices-container"),
            detailedResultsListEl = document.getElementById("detailed-results-list"),
            feedbackAreaEl = document.getElementById("feedback-area"),
            hintAreaEl = document.getElementById("hint-area"),
            modeSelectionScreen = document.getElementById("mode-selection-screen"),
            nounDisplayEl = document.getElementById("noun-display"),
            progressIndicatorEl = document.getElementById("progress-indicator"),
            quizModeBtn = document.getElementById("quiz-mode-btn"),
            quizModeScreen = document.getElementById("quiz-mode-screen"),
            restartQuizBtn = document.getElementById("restart-quiz-btn"),
            scoreIndicatorEl = document.getElementById("score-indicator"),
            speedModeBtn = document.getElementById("speed-mode-btn"),
            speedModeScreen = document.getElementById("speed-mode-screen"),
            translationDisplayEl = document.getElementById("translation-display"),
            artikelButtons = choicesContainerEl.querySelectorAll(".artikel-option-btn"),
            speedChoicesEl = document.getElementById("speed-choices"),
            speedCompleteEl = document.getElementById("speed-complete"),
            speedFeedbackEl = document.getElementById("speed-feedback"),
            speedFinalScoreEl = document.getElementById("speed-final-score"),
            speedFinalTotalEl = document.getElementById("speed-final-total"),
            speedPauseBtn = document.getElementById("speed-pause-btn"),
            speedProgressEl = document.getElementById("speed-progress"),
            speedRestartBtn = document.getElementById("speed-restart-btn"),
            speedRoundContainer = document.getElementById("speed-round-container"),
            speedTotalQsEl = document.getElementById("speed-total-qs"),
            speedWordDeEl = document.getElementById("speed-word-de"),
            speedWordTransEl = document.getElementById("speed-word-trans"),
            timerFillEl = document.getElementById("timer-fill"),
            speedBackToMenuBtn = document.getElementById("speed-back-to-menu-btn"),
            speedBackToMenuBtnIngame = document.getElementById("speed-back-to-menu-btn-ingame"),
            settingsBtn = document.getElementById("settings-btn"),
            settingsOverlay = document.getElementById("settings-overlay"),
            saveSettingsBtn = document.getElementById("save-settings-btn"),
            numQuestionsSlider = document.getElementById("num-questions-slider"),
            numQuestionsValue = document.getElementById("num-questions-value"),
            allQuestionsCheckbox = document.getElementById("all-questions-checkbox"),
            categoryCheckboxesContainer = document.getElementById("category-checkboxes"),
            quizSummaryEl = document.getElementById("quiz-summary"),
            endQuizBtn = document.getElementById("end-quiz-btn"),
            endSpeedBtn = document.getElementById("end-speed-btn"),
            speedDetailedResultsListEl = document.getElementById("speed-detailed-results-list");

        // --- Settings Functions ---
        function loadSettings() {
            const savedSettings = localStorage.getItem('quizSettings');
            const defaultSettings = {
                numQuestions: 20,
                useAllQuestions: false,
                categories: ['all']
            };
            quizSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            updateQuizSummary();
        }

        function saveSettings() {
            localStorage.setItem('quizSettings', JSON.stringify(quizSettings));
            updateQuizSummary();
        }
        
        function openSettings() {
            numQuestionsSlider.value = quizSettings.numQuestions;
            numQuestionsValue.textContent = quizSettings.numQuestions;
            allQuestionsCheckbox.checked = quizSettings.useAllQuestions;
            numQuestionsSlider.disabled = quizSettings.useAllQuestions;
            
            const availableCats = [...categoryCheckboxesContainer.querySelectorAll('input[type="checkbox"]')];
            const allCatCheckbox = availableCats.find(cb => cb.value === 'all');
            const specificCatCheckboxes = availableCats.filter(cb => cb.value !== 'all');

            if (quizSettings.categories.includes('all')) {
                allCatCheckbox.checked = true;
                specificCatCheckboxes.forEach(cb => { cb.checked = false; });
            } else {
                allCatCheckbox.checked = false;
                specificCatCheckboxes.forEach(cb => {
                    cb.checked = quizSettings.categories.includes(cb.value);
                });
            }
            settingsOverlay.classList.remove('hidden');
        }

        function handleSaveSettings() {
            quizSettings.useAllQuestions = allQuestionsCheckbox.checked;
            quizSettings.numQuestions = parseInt(numQuestionsSlider.value, 10);
            
            let selectedCategories = [...categoryCheckboxesContainer.querySelectorAll('input:checked')]
                .map(cb => cb.value);

            if(selectedCategories.length === 0) {
                selectedCategories = ['all'];
            }
            
            quizSettings.categories = selectedCategories.includes('all') ? ['all'] : selectedCategories;
            
            saveSettings();
            settingsOverlay.classList.add('hidden');
        }

        function populateCategoryCheckboxes() {
            const categories = [...new Set(allNouns.map(n => n.category))];
            let checkboxesHTML = `<label class="checkbox-label font-semibold"><input type="checkbox" value="all"> Alle Kategorien <span class="text-sm text-gray-500 ml-1">/ All</span></label>`;
            categories.forEach(cat => {
                checkboxesHTML += `<label class="checkbox-label"><input type="checkbox" value="${cat}"> ${cat}</label>`;
            });
            categoryCheckboxesContainer.innerHTML = checkboxesHTML;
            
            const allCatCheckbox = categoryCheckboxesContainer.querySelector('input[value="all"]');
            const specificCatCheckboxes = [...categoryCheckboxesContainer.querySelectorAll('input:not([value="all"])')];
            
            allCatCheckbox.addEventListener('change', () => {
                if (allCatCheckbox.checked) {
                    specificCatCheckboxes.forEach(cb => {
                        cb.checked = false;
                    });
                }
            });
            
            specificCatCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) {
                        allCatCheckbox.checked = false;
                    }
                    if (specificCatCheckboxes.every(specific => !specific.checked)) {
                        allCatCheckbox.checked = true;
                    }
                });
            });
        }
        
        function updateQuizSummary() {
            const numText = quizSettings.useAllQuestions ? 'Alle' : quizSettings.numQuestions;
            const catText = quizSettings.categories.includes('all') ? 'allen Kategorien' : `${quizSettings.categories.length} Kategorien`;
            quizSummaryEl.textContent = `Aktuell: ${numText} Fragen aus ${catText}.`;
        }

        // --- Core Functions ---
        async function loadQuizData() {
            try {
                const response = await fetch('nouns.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allNouns = await response.json();
                
                numQuestionsSlider.max = allNouns.length;
                if (parseInt(numQuestionsSlider.max, 10) < quizSettings.numQuestions) {
                    quizSettings.numQuestions = parseInt(numQuestionsSlider.max, 10);
                    saveSettings();
                }

                populateCategoryCheckboxes();
                initializeUI();
            } catch (error) {
                console.error("Could not load quiz data:", error);
                mainContainer.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Fehler beim Laden</h1><p class="mb-2">Quizdaten (JSON) nicht gefunden oder fehlerhaft.</p><p class="text-sm text-gray-700 mb-4">Details: ${error.message}</p><button onclick="location.reload()" class="btn btn-primary">Neu laden</button></div>`;
            }
        }

        function initializeUI() {
            quizModeBtn.disabled = false;
            speedModeBtn.disabled = false;
            showModeSelection();
        }

        function getFilteredQuestions() {
            let filtered = quizSettings.categories.includes('all')
                ? [...allNouns]
                : allNouns.filter(noun => quizSettings.categories.includes(noun.category));
            shuffleArray(filtered);
            return quizSettings.useAllQuestions ? filtered : filtered.slice(0, quizSettings.numQuestions);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showModeSelection() {
            modeSelectionScreen.classList.remove('hidden');
            quizModeScreen.classList.add('hidden');
            speedModeScreen.classList.add('hidden');
            clearInterval(speedInterval);
            clearAutoAdvance(autoAdvanceTimeout);
        }
        
        function triggerConfetti() { if (typeof confetti === 'function') confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } }); }
        function clearAutoAdvance(timeoutVar) { clearTimeout(timeoutVar); }

        function showQuizMode() {
            shuffledQuestions = getFilteredQuestions();
            if (shuffledQuestions.length === 0) {
                alert("Keine Nomen f√ºr die gew√§hlten Einstellungen gefunden. Bitte √§ndere die Einstellungen.");
                return;
            }
            modeSelectionScreen.classList.add('hidden');
            quizModeScreen.classList.remove('hidden');
            startQuiz();
        }

        function showSpeedMode() {
            speedQuestions = getFilteredQuestions();
            if (speedQuestions.length === 0) {
                alert("Keine Nomen f√ºr die gew√§hlten Einstellungen gefunden. Bitte √§ndere die Einstellungen.");
                return;
            }
            modeSelectionScreen.classList.add('hidden');
            speedModeScreen.classList.remove('hidden');
            startSpeedRound();
        }
        
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            answerSelected = false;
            derDieDasUserAnswers = [];
            detailedResultsListEl.classList.add('hidden');
            endQuizBtn.classList.remove('hidden');
            clearAutoAdvance(autoAdvanceTimeout);
            feedbackAreaEl.classList.add('hidden');
            feedbackAreaEl.className = "feedback-area hidden";
            restartQuizBtn.classList.add('hidden');
            hintAreaEl.classList.add('hidden');
            document.getElementById("question-area").classList.remove("hidden");
            choicesContainerEl.classList.remove("hidden");
            loadQuestion();
        }

        function loadQuestion() {
            answerSelected = false;
            clearAutoAdvance(autoAdvanceTimeout);
            if (currentQuestionIndex < shuffledQuestions.length) {
                const question = shuffledQuestions[currentQuestionIndex];
                nounDisplayEl.textContent = question.noun;
                translationDisplayEl.textContent = `${question.en} / ${question.es}`;
                feedbackAreaEl.classList.add("hidden", "correct", "incorrect");
                feedbackAreaEl.textContent = '';
                hintAreaEl.classList.add("hidden");
                enableChoiceButtons();
                updateProgress();
            } else {
                showResults();
            }
        }

        function enableChoiceButtons(enable = true) {
            artikelButtons.forEach(button => {
                button.disabled = !enable;
                button.classList.remove("opacity-50", "bg-green-600", "bg-red-600", "bg-green-400");
                button.classList.add(`btn-${button.dataset.artikel}`);
            });
        }

        function handleAnswer(selectedArtikel) {
            if (answerSelected) return;
            answerSelected = true;
            const question = shuffledQuestions[currentQuestionIndex];
            const isCorrect = selectedArtikel === question.article;
            derDieDasUserAnswers.push({
                question: JSON.parse(JSON.stringify(question)),
                userAnswer: selectedArtikel,
                isCorrect: isCorrect
            });
            feedbackAreaEl.classList.remove("hidden");
            if (isCorrect) {
                score++;
                feedbackAreaEl.innerHTML = `Richtig! <span class="correct-answer-text">${question.article} ${question.noun}</span>`;
                feedbackAreaEl.className = "feedback-area correct";
                triggerConfetti();
            } else {
                feedbackAreaEl.innerHTML = `Falsch. Richtig ist: <span class="correct-answer-text">${question.article} ${question.noun}</span>`;
                feedbackAreaEl.className = "feedback-area incorrect";
            }
            artikelButtons.forEach(btn => {
                btn.disabled = true;
                const isSelectedButton = btn.dataset.artikel === selectedArtikel;
                const isCorrectButton = btn.dataset.artikel === question.article;
                if (isSelectedButton) {
                    btn.classList.add(isCorrect ? "bg-green-600" : "bg-red-600");
                } else if (isCorrectButton) {
                    btn.classList.add("bg-green-400");
                } else {
                    btn.classList.add("opacity-50");
                }
            });
            updateProgress();
            currentQuestionIndex++;
            if (currentQuestionIndex < shuffledQuestions.length) {
                autoAdvanceTimeout = setTimeout(loadQuestion, 2000);
            } else {
                autoAdvanceTimeout = setTimeout(showResults, 2000);
            }
        }

        function updateProgress() {
            progressIndicatorEl.textContent = `Frage: ${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            scoreIndicatorEl.textContent = `Punkte: ${score} / ${derDieDasUserAnswers.length}`;
        }
        
        function showResults() {
            clearAutoAdvance(autoAdvanceTimeout);
            document.getElementById("question-area").classList.add("hidden");
            choicesContainerEl.classList.add("hidden");
            endQuizBtn.classList.add("hidden");
            feedbackAreaEl.classList.remove("hidden");
            feedbackAreaEl.className = "feedback-area correct";
            const questionsAnswered = derDieDasUserAnswers.length;
            feedbackAreaEl.innerHTML = `Quiz beendet! Endergebnis: <strong class="text-2xl">${score}</strong> / ${questionsAnswered}`;
            detailedResultsListEl.innerHTML = '';
            let resultsHTML = `<h3 class="text-purple-700">Deine Antworten im Detail:</h3><ul>`;
            derDieDasUserAnswers.forEach(ans => {
                resultsHTML += `<li class="mb-2 p-2 rounded-md ${ans.isCorrect ? "result-correct" : "result-incorrect"}">`;
                resultsHTML += `<strong>${ans.question.noun}</strong> (${ans.question.en} / ${ans.question.es}): `;
                if (ans.isCorrect) {
                    resultsHTML += `<span class="text-green-700 font-semibold">Richtig als "${ans.userAnswer.toUpperCase()}"</span>`;
                } else {
                    resultsHTML += `<span class="text-red-700">Du: "${ans.userAnswer.toUpperCase()}". Richtig:</span> <strong class="text-blue-600">"${ans.question.article.toUpperCase()}"</strong>.`;
                }
                resultsHTML += `</li>`;
            });
            resultsHTML += "</ul>";
            detailedResultsListEl.innerHTML = resultsHTML;
            detailedResultsListEl.classList.remove("hidden");
            progressIndicatorEl.textContent = "Quiz beendet!";
            scoreIndicatorEl.textContent = `Endstand: ${score} / ${questionsAnswered}`;
            restartQuizBtn.textContent = "Quiz neu starten";
            restartQuizBtn.classList.remove("hidden");
            hintAreaEl.innerHTML = "Dr√ºcke <kbd>Leertaste</kbd> zum Neustarten";
            hintAreaEl.classList.remove("hidden");
        }
        
        function startSpeedRound() {
            speedCurrentIndex = 0;
            speedScore = 0;
            speedPaused = false;
            speedAnswered = false;
            speedRoundUserAnswers = []; // Reset for new round
            speedCompleteEl.classList.add('hidden');
            speedDetailedResultsListEl.classList.add('hidden');
            speedRoundContainer.classList.remove('hidden');
            speedPauseBtn.textContent = "‚è∏Ô∏è Pause";
            showSpeedQuestion();
        }

        function showSpeedQuestion() {
            if (speedCurrentIndex >= speedQuestions.length) {
                return completeSpeedRound();
            }
            speedAnswered = false;
            const q = speedQuestions[speedCurrentIndex];
            speedWordDeEl.textContent = q.noun;
            speedWordTransEl.textContent = `${q.en} / ${q.es}`;
            speedProgressEl.textContent = `${speedCurrentIndex + 1} / ${speedQuestions.length}`;
            speedFeedbackEl.classList.add('hidden');
            speedChoicesEl.innerHTML = '';
            const articles = ["der", "die", "das"];
            const colors = { der: "btn-der", die: "btn-die", das: "btn-das" };
            articles.forEach(art => {
                const btn = document.createElement('button');
                btn.className = `btn ${colors[art]} text-lg py-4 px-5`;
                btn.textContent = art.toUpperCase();
                btn.onclick = () => handleSpeedAnswer(art);
                speedChoicesEl.appendChild(btn);
            });
            const bgColors = ['linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'];
            speedRoundContainer.style.background = bgColors[speedCurrentIndex % bgColors.length];
            startSpeedTimer();
        }

        function handleSpeedAnswer(selectedAnswer) {
            if (speedAnswered) return;
            speedAnswered = true;
            clearInterval(speedInterval);
            const q = speedQuestions[speedCurrentIndex];
            const isCorrect = selectedAnswer === q.article;
            if (isCorrect) {
                speedScore++;
            }
            speedRoundUserAnswers.push({
                question: JSON.parse(JSON.stringify(q)),
                userAnswer: selectedAnswer,
                isCorrect: isCorrect
            });
            
            speedFeedbackEl.textContent = isCorrect ? "‚úÖ Richtig!" : `‚ùå Falsch! Richtig: ${q.article.toUpperCase()}`;
            speedFeedbackEl.className = `text-lg font-bold mb-4 ${isCorrect ? 'text-green-300' : 'text-red-300'}`;
            speedFeedbackEl.classList.remove('hidden');
            
            const buttons = speedChoicesEl.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                const btnArt = btn.textContent.toLowerCase();
                if (btnArt === selectedAnswer) {
                    btn.className = isCorrect ? 'btn bg-green-600 text-lg py-4 px-5' : 'btn bg-red-600 text-lg py-4 px-5';
                } else if (btnArt === q.article) {
                    btn.className = 'btn bg-green-400 text-lg py-4 px-5';
                } else {
                    btn.className = 'btn bg-gray-500 text-lg py-4 px-5 opacity-50';
                }
            });
            speedCurrentIndex++;
            setTimeout(showSpeedQuestion, 1500);
        }

        function startSpeedTimer() {
            if (speedPaused || speedAnswered) return;
            clearInterval(speedInterval);
            timerFillEl.style.transition = 'none';
            timerFillEl.style.width = '100%';
            timerFillEl.offsetHeight; // Trigger reflow
            timerFillEl.style.transition = `width ${speedTimePerCard / 1000}s linear`;
            timerFillEl.style.width = '0%';
            speedInterval = setTimeout(() => {
                if (speedPaused || speedAnswered) return;
                speedAnswered = true;
                const q = speedQuestions[speedCurrentIndex];
                speedRoundUserAnswers.push({
                    question: JSON.parse(JSON.stringify(q)),
                    userAnswer: "Keine Antwort",
                    isCorrect: false
                });
                
                speedFeedbackEl.textContent = `‚è∞ Zeit um! Richtig: ${q.article.toUpperCase()}`;
                speedFeedbackEl.className = 'text-lg font-bold mb-4 text-orange-300';
                speedFeedbackEl.classList.remove('hidden');
                speedChoicesEl.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent.toLowerCase() === q.article) {
                        btn.className = 'btn bg-green-400 text-lg py-4 px-5';
                    } else {
                        btn.className = 'btn bg-gray-500 text-lg py-4 px-5 opacity-50';
                    }
                });
                speedCurrentIndex++;
                setTimeout(showSpeedQuestion, 1500);
            }, speedTimePerCard);
        }

        function toggleSpeedPause() {
            speedPaused = !speedPaused;
            speedPauseBtn.textContent = speedPaused ? "‚ñ∂Ô∏è Weiter" : "‚è∏Ô∏è Pause";
            if (speedPaused) {
                clearInterval(speedInterval);
                const compStyle = getComputedStyle(timerFillEl);
                timerFillEl.style.width = compStyle.width;
                timerFillEl.style.transition = 'none';
            } else {
                if (speedCurrentIndex < speedQuestions.length && !speedAnswered) {
                    const currWidthPx = parseFloat(getComputedStyle(timerFillEl).width);
                    const parWidthPx = timerFillEl.parentNode.offsetWidth;
                    const remTime = (currWidthPx / parWidthPx) * speedTimePerCard;
                    timerFillEl.style.transition = `width ${remTime / 1000}s linear`;
                    timerFillEl.style.width = '0%';
                    speedInterval = setTimeout(() => {
                        if (speedPaused || speedAnswered) return;
                        speedAnswered = true;
                        speedCurrentIndex++;
                        showSpeedQuestion();
                    }, remTime);
                }
            }
        }
        
        function completeSpeedRound() {
            clearInterval(speedInterval);
            speedRoundContainer.classList.add("hidden");
            speedCompleteEl.classList.remove("hidden");
            
            const questionsAnswered = speedRoundUserAnswers.length;
            speedFinalScoreEl.textContent = speedScore;
            speedTotalQsEl.textContent = questionsAnswered;
            speedFinalTotalEl.textContent = questionsAnswered;
            
            // Build and display detailed results
            speedDetailedResultsListEl.innerHTML = '';
            let resultsHTML = `<h3 class="text-purple-700">Deine Antworten im Detail:</h3><ul>`;
            speedRoundUserAnswers.forEach(ans => {
                resultsHTML += `<li class="mb-2 p-2 rounded-md ${ans.isCorrect ? "result-correct" : "result-incorrect"}">`;
                resultsHTML += `<strong>${ans.question.noun}</strong>: `;
                if (ans.isCorrect) {
                    resultsHTML += `<span class="text-green-700 font-semibold">Richtig als "${ans.userAnswer.toUpperCase()}"</span>`;
                } else {
                    resultsHTML += `<span class="text-red-700">Du: "${ans.userAnswer.toUpperCase()}". Richtig:</span> <strong class="text-blue-600">"${ans.question.article.toUpperCase()}"</strong>.`;
                }
                resultsHTML += `</li>`;
            });
            resultsHTML += "</ul>";
            speedDetailedResultsListEl.innerHTML = resultsHTML;
            speedDetailedResultsListEl.classList.remove("hidden");

            if (speedScore > 0) {
                triggerConfetti();
            }
        }
        
        function handleSpacebar(e) {
            if (e.code !== "Space" && e.keyCode !== 32) return;
            if (document.activeElement && (document.activeElement.tagName === "BUTTON" || document.activeElement.tagName === "INPUT") && !["restart-quiz-btn"].includes(document.activeElement.id)) return;
            e.preventDefault();
            if (!quizModeScreen.classList.contains("hidden")) {
                if (!restartQuizBtn.classList.contains("hidden")) {
                    restartQuizBtn.click();
                }
            }
        }
        
        async function initialSetup() {
            quizModeBtn.disabled = true;
            speedModeBtn.disabled = true;
            settingsBtn.disabled = true;
            
            const loadingMsg = document.createElement('p');
            loadingMsg.textContent = "Lade Quizdaten...";
            modeSelectionScreen.querySelector('.mode-selection').insertAdjacentElement('beforebegin', loadingMsg);

            loadSettings();
            await loadQuizData();
            
            settingsBtn.disabled = false;
            loadingMsg.remove();
        }

        // --- Event Listeners ---
        quizModeBtn.addEventListener("click", showQuizMode);
        speedModeBtn.addEventListener("click", showSpeedMode);
        backToMenuBtn.addEventListener("click", showModeSelection);
        artikelButtons.forEach(e => { e.addEventListener("click", () => handleAnswer(e.dataset.artikel)) });
        speedPauseBtn.addEventListener("click", toggleSpeedPause);
        speedRestartBtn.addEventListener("click", startSpeedRound);
        speedBackToMenuBtn.addEventListener("click", showModeSelection);
        speedBackToMenuBtnIngame.addEventListener("click", showModeSelection);
        document.addEventListener("keydown", handleSpacebar);
        settingsBtn.addEventListener("click", openSettings);
        saveSettingsBtn.addEventListener("click", handleSaveSettings);
        numQuestionsSlider.addEventListener("input", e => { numQuestionsValue.textContent = e.target.value });
        allQuestionsCheckbox.addEventListener("change", e => { numQuestionsSlider.disabled = e.target.checked });
        endQuizBtn.addEventListener("click", showResults);
        endSpeedBtn.addEventListener("click", completeSpeedRound);

        // --- App Start ---
        initialSetup();
    </script>
</body>
</html>
