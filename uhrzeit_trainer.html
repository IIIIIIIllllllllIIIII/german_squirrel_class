<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>German Clock Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #0575e6, #02b3e4, #00f2c1, #a8ff78, #f9f871);
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            margin: 0;
            padding: 24px; 
            color: #374151; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; 
        }
        .card {
            background-color: white;
            padding: 24px; 
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            width: 100%;
            max-width: 800px; 
        }
        @media (min-width: 768px) { .card { padding: 32px; } }

        .mode-title { font-size: 1.75rem; font-weight: 700; color: #005c97; }
        .mode-title-subtitle { font-size: 1rem; color: #363795; margin-bottom: 24px; }

        #mode-selection-container .mode-btn {
            display: block; width: 100%; max-width: 400px; margin: 1rem auto;
            padding: 1rem; font-size: 1.25rem;
        }

        .clock-and-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        #clock-canvas {
            width: 100%;
            max-width: 250px;
            height: auto;
            aspect-ratio: 1 / 1;
        }

        #digital-time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: #005c97;
            background-color: #f0f9ff;
            padding: 0.5rem 1.5rem;
            border-radius: 12px;
            border: 2px solid #e0f2fe;
        }
        
        .drop-zone-container {
            background-color: #eef2ff;
            border: 2px dashed #a5b4fc;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; 
            justify-content: flex-start;
            align-items: center; 
            margin-bottom: 1.5rem;
        }
        
        .draggable-item-slot {
            min-width: 80px;
            height: 45px; 
            background-color: #e0e7ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.375rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        .draggable-item-slot.drag-over { background-color: #c7d2fe; border-color: #818cf8; }

        .draggable-pool {
            background-color: #f0f9ff;
            border: 2px dashed #7dd3fc;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; 
            justify-content: center;
            align-items: center; 
            margin-bottom: 1.5rem;
        }

        .draggable-item {
            background-image: linear-gradient(to right, #6dd5ed 0%, #2193b0 100%);
            color: white;
            padding: 10px 18px; 
            border-radius: 9999px; 
            cursor: grab; 
            font-weight: 600; 
            font-size: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            transition: all 0.2s ease-out; 
            border: 2px solid #1c7c94; 
            user-select: none;
        }
        .draggable-item:hover { transform: translateY(-2px) scale(1.05); }
        .draggable-item.dragging { opacity: 0.6; transform: rotate(3deg); cursor: grabbing; }
        .draggable-item.correct-in-slot { background-image: linear-gradient(to right, #86efac, #34d399); border-color: #10b981;}
        .draggable-item.incorrect-in-slot { background-image: linear-gradient(to right, #fca5a5, #f87171); border-color: #ef4444;}
        
        .feedback-area { margin-top: 1.5rem; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; }
        .feedback-area.success { background-color: #dcfce7; color: #166534; border: 1px solid #6ee7b7;} 
        .feedback-area.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;} 
        
        .btn { padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .btn:disabled { background-color: #d1d5db !important; color: #6b7280 !important; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: #0072ff; }
        .btn-primary:hover:not(:disabled) { background-color: #005bb5; }
        .btn-secondary { background-color: #64748b; } 
        .btn-secondary:hover:not(:disabled) { background-color: #475569; } 
        .hidden { display: none !important; }
        .bottom-controls { margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;}
    </style>
</head>
<body>
    <div class="card">
        <!-- Mode Selection Screen -->
        <div id="mode-selection-screen">
            <h1 class="mode-title">Die Uhrzeit lernen</h1>
            <p class="mode-title-subtitle">Choose a mode / Wähle einen Modus</p>
            <div id="mode-selection-container">
                <button class="btn btn-primary mode-btn" data-mode="formal">Formelle Uhrzeit (Formal)</button>
                <button class="btn btn-primary mode-btn" data-mode="colloquial">Umgangssprachliche Uhrzeit (Colloquial)</button>
            </div>
             <div class="mt-8 pt-6 border-t border-gray-200">
                <a href="index.html" class="btn btn-secondary">← Back to Main Menu</a>
           </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <h1 class="mode-title" id="quiz-mode-title">Clock Trainer</h1>
            <p class="mode-title-subtitle">Build the sentence / Baue den Satz</p>

            <div class="clock-and-display">
                <canvas id="clock-canvas" width="300" height="300"></canvas>
                <div id="digital-time-display">00:00</div>
            </div>

            <div id="drop-zone-container" class="drop-zone-container"></div>
            <div id="draggable-pool" class="draggable-pool"></div>
            
            <div id="feedback-message" class="feedback-area hidden"></div>
            <div id="correct-sentence-feedback" class="text-green-700 font-semibold mt-2 hidden"></div>

            <div class="bottom-controls">
                <button id="check-answer-btn" class="btn btn-primary">Check Answer / Verificar</button>
                <button id="next-task-btn" class="btn btn-secondary hidden">Next Time / Siguiente</button>
                <button id="back-to-mode-selection-btn" class="btn btn-secondary">Change Mode / Modus wechseln</button>
            </div>
        </div>
    </div>

    <script>
        let allTasks = [];
        let currentTask = null;
        let shuffledTasks = [];
        let draggedItem = null;
        let currentMode = 'formal'; // 'formal' or 'colloquial'

        // --- DOM Elements ---
        const canvas = document.getElementById('clock-canvas');
        const ctx = canvas.getContext('2d');
        const radius = canvas.height / 2;
        ctx.translate(radius, radius);

        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const quizModeTitle = document.getElementById('quiz-mode-title');
        const digitalTimeDisplayEl = document.getElementById('digital-time-display');
        const dropZoneContainerEl = document.getElementById('drop-zone-container');
        const draggablePoolEl = document.getElementById('draggable-pool');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextTaskBtn = document.getElementById('next-task-btn');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const correctSentenceFeedbackEl = document.getElementById('correct-sentence-feedback');
        const backToModeSelectionBtn = document.getElementById('back-to-mode-selection-btn');

        // --- Clock Drawing Functions ---
        function drawClock() {
            ctx.clearRect(-radius, -radius, canvas.width, canvas.height);
            drawFace(ctx, radius);
            drawNumbers(ctx, radius);
        }

        function drawFace(ctx, radius) {
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.95, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            const grad = ctx.createRadialGradient(0, 0, radius * 0.85, 0, 0, radius * 1.05);
            grad.addColorStop(0, '#e0f2fe');
            grad.addColorStop(0.5, 'white');
            grad.addColorStop(1, '#e0f2fe');
            ctx.strokeStyle = grad;
            ctx.lineWidth = radius * 0.1;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.05, 0, 2 * Math.PI);
            ctx.fillStyle = '#333';
            ctx.fill();
        }

        function drawNumbers(ctx, radius) {
            ctx.font = radius * 0.15 + "px Inter, sans-serif";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            for (let num = 1; num <= 12; num++) {
                const ang = num * Math.PI / 6;
                ctx.rotate(ang);
                ctx.translate(0, -radius * 0.8);
                ctx.rotate(-ang);
                ctx.fillText(num.toString(), 0, 0);
                ctx.rotate(ang);
                ctx.translate(0, radius * 0.8);
                ctx.rotate(-ang);
            }
        }

        function drawTime(hour, minute) {
            drawClock();
            hour = hour % 12;
            hour = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60));
            drawHand(ctx, hour, radius * 0.5, radius * 0.07);
            minute = (minute * Math.PI / 30);
            drawHand(ctx, minute, radius * 0.75, radius * 0.05);
        }

        function drawHand(ctx, pos, length, width) {
            ctx.beginPath();
            ctx.lineWidth = width;
            ctx.lineCap = "round";
            ctx.moveTo(0, 0);
            ctx.rotate(pos);
            ctx.lineTo(0, -length);
            ctx.stroke();
            ctx.rotate(-pos);
        }

        // --- Quiz Logic ---
        async function loadTasks() {
            try {
                const response = await fetch('uhrzeit_tasks.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                allTasks = await response.json();
                if (!Array.isArray(allTasks) || allTasks.length === 0) {
                    throw new Error("JSON file is empty or not a valid array.");
                }
            } catch (error) {
                console.error("Could not load or parse tasks:", error);
                document.querySelector('.card').innerHTML = `<p class="text-red-500 font-semibold">Error loading tasks. Please check the console and the uhrzeit_tasks.json file. <br> Details: ${error.message}</p>`;
            }
        }

        function startQuiz(mode) {
            currentMode = mode;
            modeSelectionScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            quizModeTitle.textContent = mode === 'formal' ? 'Formelle Uhrzeit' : 'Umgangssprachliche Uhrzeit';

            shuffleArray(allTasks);
            shuffledTasks = [...allTasks];
            loadNextTask();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createDraggableItem(text) {
            const item = document.createElement('div');
            item.classList.add('draggable-item');
            item.textContent = text;
            item.draggable = true;
            item.dataset.text = text;
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
            return item;
        }

        function loadNextTask() {
            if (shuffledTasks.length === 0) {
                dropZoneContainerEl.innerHTML = `<p class="text-blue-700 font-semibold text-lg">Super! Alle Uhrzeiten geübt!</p>`;
                draggablePoolEl.innerHTML = '';
                digitalTimeDisplayEl.textContent = 'Done!';
                checkAnswerBtn.classList.add('hidden');
                nextTaskBtn.classList.add('hidden');
                return;
            }

            currentTask = shuffledTasks.shift();
            digitalTimeDisplayEl.textContent = currentTask.time;
            drawTime(currentTask.hour, currentTask.minute);

            const correctWords = currentTask[currentMode + '_words'];
            
            dropZoneContainerEl.innerHTML = '';
            correctWords.forEach(() => {
                const slot = document.createElement('div');
                slot.classList.add('draggable-item-slot');
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
                dropZoneContainerEl.appendChild(slot);
            });

            const wordsToDrag = [...correctWords, ...currentTask.distractor_words];
            shuffleArray(wordsToDrag);
            draggablePoolEl.innerHTML = '';
            wordsToDrag.forEach(word => draggablePoolEl.appendChild(createDraggableItem(word)));

            feedbackMessageEl.classList.add('hidden');
            correctSentenceFeedbackEl.classList.add('hidden');
            checkAnswerBtn.disabled = false;
            checkAnswerBtn.classList.remove('hidden');
            nextTaskBtn.classList.add('hidden');
        }

        // --- Event Handlers & Drag/Drop ---
        function handleDragStart(e) {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        function handleDragOver(e) {
            e.preventDefault();
        }
        function handleDrop(e) {
            e.preventDefault();
            const target = e.target;
            const isSlot = target.classList.contains('draggable-item-slot');
            const isPool = target.classList.contains('draggable-pool');

            if (isSlot && !target.hasChildNodes()) {
                target.appendChild(draggedItem);
            } else if (isPool) {
                target.appendChild(draggedItem);
            } else if (target.closest('.draggable-item-slot') && !target.closest('.draggable-item-slot').hasChildNodes()) {
                 target.closest('.draggable-item-slot').appendChild(draggedItem);
            } else {
                draggablePoolEl.appendChild(draggedItem);
            }
        }

        checkAnswerBtn.addEventListener('click', () => {
            checkAnswerBtn.disabled = true;
            const slots = dropZoneContainerEl.querySelectorAll('.draggable-item-slot');
            let constructedSentence = Array.from(slots).map(slot => slot.firstChild ? slot.firstChild.dataset.text : '').join(' ');
            let allSlotsFilled = Array.from(slots).every(slot => slot.firstChild);

            if (!allSlotsFilled) {
                feedbackMessageEl.textContent = "Please fill all blanks. / Por favor, llena todos los espacios.";
                feedbackMessageEl.className = "feedback-area error";
                feedbackMessageEl.classList.remove('hidden');
                checkAnswerBtn.disabled = false;
                return;
            }

            const correctSentence = currentTask[currentMode + '_sentence'];
            const isCorrect = constructedSentence.trim() === correctSentence.trim();
            
            slots.forEach(slot => {
                const item = slot.firstChild;
                if (item) {
                    item.classList.toggle('correct-in-slot', isCorrect);
                    item.classList.toggle('incorrect-in-slot', !isCorrect);
                }
            });

            if (isCorrect) {
                feedbackMessageEl.textContent = "Richtig! / Correct!";
                feedbackMessageEl.className = "feedback-area success";
                triggerConfetti();
            } else {
                feedbackMessageEl.textContent = "Leider nicht ganz richtig. / Not quite right.";
                feedbackMessageEl.className = "feedback-area error";
                correctSentenceFeedbackEl.textContent = `Correct Order: ${correctSentence}`;
                correctSentenceFeedbackEl.classList.remove('hidden');
            }
            
            feedbackMessageEl.classList.remove('hidden');
            checkAnswerBtn.classList.add('hidden');
            nextTaskBtn.classList.remove('hidden');
        });

        nextTaskBtn.addEventListener('click', loadNextTask);
        
        backToModeSelectionBtn.addEventListener('click', () => {
            quizScreen.classList.add('hidden');
            modeSelectionScreen.classList.remove('hidden');
        });
        
        document.getElementById('mode-selection-container').addEventListener('click', (e) => {
            if (e.target.matches('.mode-btn')) {
                startQuiz(e.target.dataset.mode);
            }
        });

        function triggerConfetti() { if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }

        // --- Initial Load ---
        loadTasks();

    </script>
</body>
</html>
