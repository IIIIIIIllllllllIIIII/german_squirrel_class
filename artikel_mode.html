<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Deutsche Artikel Quiz (Der, Die, Das)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #d928a9, #f65ce0, #fa8bf5, #fdb5fa, #fed6fe);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 16px;
            color: #374151;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            width: 100%;
            max-width: 700px;
            position: relative; /* For settings button positioning */
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-top: 8px;
        }
        .btn:disabled {
            background-color: #d1d5db !important;
            color: #6b7280 !important;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary { background-color: #6d28d9; }
        .btn-primary:hover:not(:disabled) { background-color: #5b21b6; }
        .btn-secondary { background-color: #4f46e5; }
        .btn-secondary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-success { background-color: #059669; }
        .btn-success:hover:not(:disabled) { background-color: #047857; }

        /* Settings Panel Styles */
        #settings-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.75rem; /* text-3xl */
            cursor: pointer;
            color: #9ca3af; /* gray-400 */
            transition: color 0.3s;
        }
        #settings-btn:hover { color: #4b5563; /* gray-600 */ }
        #settings-modal {
             position: absolute;
             inset: 0;
             background-color: rgba(255, 255, 255, 0.98);
             backdrop-filter: blur(4px);
             padding: 24px;
             border-radius: 16px;
             display: flex;
             flex-direction: column;
             text-align: left;
             z-index: 50;
        }
        .settings-section { margin-bottom: 24px; }
        .settings-section h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 12px; color: #4a044e; }
        #category-checkboxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 6px; transition: background-color 0.2s; }
        .checkbox-label:hover { background-color: #f3f4f6; }
        .checkbox-label input { margin-right: 10px; width: 1.1em; height: 1.1em; }

        /* Other styles from before... */
        .artikel-option-btn{padding:18px 12px;font-size:1.2rem;line-height:1.3;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80px;flex-basis:calc(33.333% - 12px);min-width:120px;word-break:break-word}.btn-der{background-color:#2563eb}.btn-der:hover:not(:disabled){background-color:#1d4ed8}.btn-die{background-color:#dc2626}.btn-die:hover:not(:disabled){background-color:#b91c1c}.btn-das{background-color:#16a34a}.btn-das:hover:not(:disabled){background-color:#15803d}.speed-round-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:20px;text-align:center;min-height:400px;display:flex;flex-direction:column;justify-content:center}.speed-round-word{font-size:4rem;font-weight:800;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,.3)}.speed-round-meaning{font-size:1.5rem;margin:10px 0;opacity:.9}.timer-bar{width:100%;height:8px;background-color:rgba(255,255,255,.3);border-radius:4px;overflow:hidden;margin:20px 0}.timer-fill{height:100%;background-color:#10b981;transition:width .1s linear;border-radius:4px}.feedback-area{font-size:.95rem;font-weight:500;padding:12px;border-radius:8px;min-height:60px;margin-bottom:1rem;text-align:center}.feedback-area.correct{color:#065f46;background-color:#dcfce7;border:1px solid #bbf7d0;display:block!important}.feedback-area.incorrect{color:#b91c1c;background-color:#fee2e2;border:1px solid #fecaca;display:block!important}.feedback-area .correct-answer-text,.feedback-area strong{font-weight:700}.detailed-results-list{margin-top:1rem;text-align:left;max-height:200px;overflow-y:auto;padding:.75rem;border:1px solid #e5e7eb;border-radius:8px;background-color:#f9fafb}.detailed-results-list h3{font-size:1.125rem;font-weight:600;margin-bottom:.75rem}.detailed-results-list ul{list-style:none;padding:0}.detailed-results-list li{margin-bottom:.75rem;padding:.5rem;border-radius:6px;font-size:.875rem}.result-correct{background-color:#ecfdf5;border-left:4px solid #10b981}.result-incorrect{background-color:#fff1f2;border-left:4px solid #f43f5e}.progress-text{margin-top:12px;font-size:.875rem;color:#6b7280}.hidden{display:none!important}#noun-display{font-size:2.5rem;font-weight:700;color:#4a044e;margin-bottom:.5rem}#translation-display{font-size:1rem;color:#6b7280;font-style:italic;margin-bottom:2rem;min-height:40px}#artikel-choices-container{display:flex;flex-wrap:wrap;justify-content:center;gap:16px}.mode-selection{display:flex;gap:16px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}.mode-btn{padding:16px 24px;font-size:1.1rem;border-radius:12px;min-width:200px}kbd{font-family:monospace;background-color:#e2e8f0;color:#4a5568;padding:3px 6px;border-radius:4px;border:1px solid #cbd5e0;font-size:.85em;box-shadow:1px 1px 1px rgba(0,0,0,.1)}@media (max-width:768px){#artikel-choices-container .btn{flex-basis:calc(33.333% - 10px);font-size:1.1rem}.mode-selection{flex-direction:column;align-items:center}.speed-round-word{font-size:3rem}#noun-display{font-size:2rem}.detailed-results-list{max-height:180px}}@media (max-width:640px){.card{padding:20px}.btn{padding:10px 16px;font-size:.9rem}.artikel-option-btn{font-size:1rem;min-height:70px}#noun-display{font-size:1.8rem}.feedback-area{font-size:.9rem;min-height:50px}#artikel-choices-container .btn{flex-basis:calc(100% - 8px);min-width:100px}.speed-round-word{font-size:2.5rem}.speed-round-meaning{font-size:1.2rem}.detailed-results-list{max-height:150px;font-size:.8rem}.detailed-results-list li{font-size:.8rem}}
    </style>
</head>
<body>
    <div id="main-container" class="card">
        <div id="mode-selection-screen" class="">
            <button id="settings-btn">‚öôÔ∏è</button>
            <h1 class="text-2xl sm:text-3xl font-bold text-purple-700 mb-6 text-center">Deutsche Nomen Artikel</h1>
            <div class="mode-selection">
                <button id="quiz-mode-btn" class="btn btn-primary mode-btn">
                    üìù Der/Die/Das Quiz
                    <div class="text-sm opacity-90 mt-1">Teste dein Wissen</div>
                </button>
                <button id="speed-mode-btn" class="btn btn-success mode-btn">
                    ‚ö° Speed Learning
                    <div class="text-sm opacity-90 mt-1">Schnelle Karteikarten</div>
                </button>
            </div>
            <p id="quiz-summary" class="text-sm text-gray-500 mt-4"></p>
        </div>

        <div id="quiz-mode-screen" class="hidden">
            <h1 class="text-2xl sm:text-3xl font-bold text-purple-700 mb-6 text-center">Der, Die, oder Das?</h1>
            <div id="question-area" class="mb-6">
                 <p id="noun-display" class="text-center" style="min-height: 60px;"></p>
                 <p id="translation-display" class="text-center"></p>
            </div>
            <div id="artikel-choices-container" class="mb-6">
                <button id="der-btn" class="btn artikel-option-btn btn-der" data-artikel="der">DER</button>
                <button id="die-btn" class="btn artikel-option-btn btn-die" data-artikel="die">DIE</button>
                <button id="das-btn" class="btn artikel-option-btn btn-das" data-artikel="das">DAS</button>
            </div>
            <div id="feedback-area" class="feedback-area hidden"></div>
            <div id="detailed-results-list" class="detailed-results-list hidden"></div>
            <div id="quiz-controls-area" class="text-center mt-4">
                <button id="restart-quiz-btn" class="btn btn-secondary hidden">Quiz neu starten</button>
                <button id="back-to-menu-btn" class="btn btn-secondary">Zur√ºck zum Men√º</button>
            </div>
            <div id="progress-indicator" class="progress-text mt-4 text-center">Frage 0 / 0</div>
            <div id="score-indicator" class="progress-text mt-1 text-center">Punkte: 0 / 0</div>
            <div id="hint-area" class="progress-text mt-3 text-center hidden"></div>
        </div>

         <div id="speed-mode-screen" class="hidden">
            <div id="speed-round-container" class="speed-round-card">
                <div id="speed-question-text" class="text-xl mb-4 opacity-90">Welcher Artikel?</div>
                <div id="speed-word-de" class="speed-round-word text-yellow-200">Haus</div>
                <div id="speed-word-trans" class="speed-round-meaning text-yellow-100">House / Casa</div>
                <div class="timer-bar">
                    <div id="timer-fill" class="timer-fill" style="width: 100%;"></div>
                </div>
                <div id="speed-choices" class="grid grid-cols-3 gap-4 mt-6 mb-4"></div>
                <div id="speed-feedback" class="text-lg font-bold mb-4 hidden"></div>
                <div id="speed-progress" class="text-lg opacity-90">1 / 100</div>
                <div id="speed-controls" class="mt-6">
                     <button id="speed-pause-btn" class="btn btn-secondary mr-4">‚è∏Ô∏è Pause</button>
                     <button id="speed-back-to-menu-btn-ingame" class="btn btn-secondary">Zur√ºck</button>
                </div>
            </div>
            <div id="speed-complete" class="hidden text-center">
                <h2 class="text-2xl font-bold text-green-600 mb-4">üéâ Speed Runde geschafft!</h2>
                <p class="text-lg mb-2">Du hast <span id="speed-total-qs">100</span> Fragen beantwortet!</p>
                <p class="text-xl font-bold text-purple-600 mb-6">Endstand: <span id="speed-final-score">0</span> / <span id="speed-final-total">100</span></p>
                <button id="speed-restart-btn" class="btn btn-success mr-4">üîÑ Neu starten</button>
                <button id="speed-back-to-menu-btn" class="btn btn-secondary">Zur√ºck zum Men√º</button>
            </div>
        </div>
        
        <div id="settings-modal" class="hidden">
            <h2 class="text-2xl font-bold text-purple-700 mb-6">Einstellungen</h2>
            <div class="settings-section flex-grow overflow-y-auto">
                <div class="settings-section">
                    <h3>Anzahl der Fragen</h3>
                    <div class="flex items-center gap-4">
                        <input type="range" id="num-questions-slider" min="5" max="40" value="20" class="w-full">
                        <span id="num-questions-value" class="font-bold text-purple-700 w-12 text-center">20</span>
                         <label class="flex items-center gap-2"><input type="checkbox" id="all-questions-checkbox"> Alle</label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Kategorien</h3>
                    <div id="category-checkboxes">
                        </div>
                </div>
            </div>
            <div class="mt-auto pt-4">
                <button id="save-settings-btn" class="btn btn-primary w-full">Speichern & Schlie√üen</button>
            </div>
        </div>

    </div>

    <script>
       // --- Global Variables ---
       let allNouns = []; // Will hold all nouns from JSON
       let derDieDasUserAnswers = [];
       let quizSettings = {}; // To hold user settings

        // Quiz Mode (DerDieDas) Variables
        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestions = [];
        let answerSelected = false;
        let autoAdvanceTimeout;

        // Speed Mode Variables
        let speedCurrentIndex = 0;
        let speedInterval;
        let speedPaused = false;
        let speedTimePerCard = 5000;
        let speedQuestions = [];
        let speedScore = 0;
        let speedAnswered = false;

        // --- Element Caching ---
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const quizModeScreen = document.getElementById('quiz-mode-screen');
        const speedModeScreen = document.getElementById('speed-mode-screen');
        const quizModeBtn = document.getElementById('quiz-mode-btn');
        const speedModeBtn = document.getElementById('speed-mode-btn');
        const nounDisplayEl = document.getElementById('noun-display');
        const translationDisplayEl = document.getElementById('translation-display');
        const choicesContainerEl = document.getElementById('artikel-choices-container');
        const feedbackAreaEl = document.getElementById('feedback-area');
        const detailedResultsListEl = document.getElementById('detailed-results-list');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const progressIndicatorEl = document.getElementById('progress-indicator');
        const scoreIndicatorEl = document.getElementById('score-indicator');
        const hintAreaEl = document.getElementById('hint-area');
        const artikelButtons = choicesContainerEl.querySelectorAll('.artikel-option-btn');
        const speedWordDeEl = document.getElementById('speed-word-de');
        const speedWordTransEl = document.getElementById('speed-word-trans');
        const speedChoicesEl = document.getElementById('speed-choices');
        const speedFeedbackEl = document.getElementById('speed-feedback');
        const timerFillEl = document.getElementById('timer-fill');
        const speedProgressEl = document.getElementById('speed-progress');
        const speedPauseBtn = document.getElementById('speed-pause-btn');
        const speedCompleteEl = document.getElementById('speed-complete');
        const speedRestartBtn = document.getElementById('speed-restart-btn');
        const speedBackToMenuBtn = document.getElementById('speed-back-to-menu-btn');
        const speedBackToMenuBtnIngame = document.getElementById('speed-back-to-menu-btn-ingame');
        const speedFinalScoreEl = document.getElementById('speed-final-score');
        const speedTotalQsEl = document.getElementById('speed-total-qs');
        const speedFinalTotalEl = document.getElementById('speed-final-total');
        const speedRoundContainer = document.getElementById('speed-round-container');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const numQuestionsSlider = document.getElementById('num-questions-slider');
        const numQuestionsValue = document.getElementById('num-questions-value');
        const allQuestionsCheckbox = document.getElementById('all-questions-checkbox');
        const categoryCheckboxesContainer = document.getElementById('category-checkboxes');
        const quizSummaryEl = document.getElementById('quiz-summary');
        
        // --- Settings Functions ---
        function loadSettings() {
            const savedSettings = localStorage.getItem('quizSettings');
            const defaultSettings = {
                numQuestions: 20,
                useAllQuestions: false,
                categories: ['all'] // 'all' is a special value
            };
            quizSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            updateQuizSummary();
        }

        function saveSettings() {
            localStorage.setItem('quizSettings', JSON.stringify(quizSettings));
            updateQuizSummary();
        }
        
        function openSettings() {
            // Update UI to reflect current settings
            numQuestionsSlider.value = quizSettings.numQuestions;
            numQuestionsValue.textContent = quizSettings.numQuestions;
            allQuestionsCheckbox.checked = quizSettings.useAllQuestions;
            numQuestionsSlider.disabled = quizSettings.useAllQuestions;
            
            // Set checkbox states
            const availableCats = [...categoryCheckboxesContainer.querySelectorAll('input[type="checkbox"]')];
            const allCatCheckbox = availableCats.find(cb => cb.value === 'all');
            const specificCatCheckboxes = availableCats.filter(cb => cb.value !== 'all');

            if (quizSettings.categories.includes('all')) {
                allCatCheckbox.checked = true;
                specificCatCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = true; });
            } else {
                allCatCheckbox.checked = false;
                specificCatCheckboxes.forEach(cb => {
                    cb.disabled = false;
                    cb.checked = quizSettings.categories.includes(cb.value);
                });
            }
            settingsModal.classList.remove('hidden');
        }

        function handleSaveSettings() {
            quizSettings.useAllQuestions = allQuestionsCheckbox.checked;
            quizSettings.numQuestions = parseInt(numQuestionsSlider.value, 10);
            
            const selectedCategories = [...categoryCheckboxesContainer.querySelectorAll('input:checked')]
                .map(cb => cb.value);

            // If "All Categories" is checked, it overrides others. Otherwise, get the list.
            if (selectedCategories.includes('all')) {
                 quizSettings.categories = ['all'];
            } else {
                 quizSettings.categories = selectedCategories.length > 0 ? selectedCategories : ['all']; // Default to all if none selected
            }
            
            saveSettings();
            settingsModal.classList.add('hidden');
        }

        function populateCategoryCheckboxes() {
            const categories = [...new Set(allNouns.map(n => n.category))];
            let checkboxesHTML = `<label class="checkbox-label font-semibold"><input type="checkbox" value="all"> Alle Kategorien</label>`;
            categories.forEach(cat => {
                checkboxesHTML += `<label class="checkbox-label"><input type="checkbox" value="${cat}"> ${cat}</label>`;
            });
            categoryCheckboxesContainer.innerHTML = checkboxesHTML;
            
            // Add event listeners for the new checkboxes
            const allCatCheckbox = categoryCheckboxesContainer.querySelector('input[value="all"]');
            // FIX: The selector 'input[value!="all"]' is invalid. Use :not().
            const specificCatCheckboxes = [...categoryCheckboxesContainer.querySelectorAll('input:not([value="all"])')];
            
            allCatCheckbox.addEventListener('change', () => {
                specificCatCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.disabled = allCatCheckbox.checked;
                });
            });
        }
        
        function updateQuizSummary() {
            const numText = quizSettings.useAllQuestions ? 'Alle' : quizSettings.numQuestions;
            const catText = quizSettings.categories.includes('all') ? 'allen Kategorien' : `${quizSettings.categories.length} Kategorien`;
            quizSummaryEl.textContent = `Aktuell: ${numText} Fragen aus ${catText}.`;
        }

        // --- Core Functions ---
        async function loadQuizData() {
            try {
                const response = await fetch('nouns.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allNouns = await response.json();
                
                numQuestionsSlider.max = allNouns.length;
                
                populateCategoryCheckboxes();
                initializeUI();
            } catch (error) {
                console.error("Could not load quiz data:", error);
                const mainContainer = document.getElementById('main-container');
                mainContainer.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Fehler beim Laden</h1><p class="mb-2">Quizdaten (JSON) nicht gefunden oder fehlerhaft.</p><p class="text-sm text-gray-700 mb-4">Details: ${error.message}</p><button onclick="location.reload()" class="btn btn-primary">Neu laden</button></div>`;
            }
        }

        function initializeUI() {
            quizModeBtn.disabled = false;
            speedModeBtn.disabled = false;
            showModeSelection();
        }

        function getFilteredQuestions() {
            let filtered = quizSettings.categories.includes('all')
                ? [...allNouns]
                : allNouns.filter(noun => quizSettings.categories.includes(noun.category));

            shuffleArray(filtered);

            return quizSettings.useAllQuestions
                ? filtered
                : filtered.slice(0, quizSettings.numQuestions);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showModeSelection() {
            modeSelectionScreen.classList.remove('hidden');
            quizModeScreen.classList.add('hidden');
            speedModeScreen.classList.add('hidden');
            clearInterval(speedInterval);
            clearAutoAdvance(autoAdvanceTimeout);
        }
        
        function triggerConfetti() { if (typeof confetti === 'function') confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } }); }
        function clearAutoAdvance(timeoutVar) { clearTimeout(timeoutVar); }

        function showQuizMode() {
            shuffledQuestions = getFilteredQuestions();
            if (shuffledQuestions.length === 0) {
                alert("Keine Nomen f√ºr die gew√§hlten Einstellungen gefunden. Bitte √§ndere die Einstellungen.");
                return;
            }
            modeSelectionScreen.classList.add('hidden');
            quizModeScreen.classList.remove('hidden');
            startQuiz();
        }

        function showSpeedMode() {
            speedQuestions = getFilteredQuestions();
            if (speedQuestions.length === 0) {
                alert("Keine Nomen f√ºr die gew√§hlten Einstellungen gefunden. Bitte √§ndere die Einstellungen.");
                return;
            }
            modeSelectionScreen.classList.add('hidden');
            speedModeScreen.classList.remove('hidden');
            startSpeedRound();
        }

        // --- DerDieDas Quiz Functions (no major changes, just uses 'shuffledQuestions') ---
        function startQuiz(){shuffledQuestions.length>0&&(currentQuestionIndex=0,score=0,answerSelected=!1,derDieDasUserAnswers=[],detailedResultsListEl.classList.add("hidden"),clearAutoAdvance(autoAdvanceTimeout),feedbackAreaEl.classList.add("hidden"),feedbackAreaEl.className="feedback-area hidden",restartQuizBtn.classList.add("hidden"),hintAreaEl.classList.add("hidden"),document.getElementById("question-area").classList.remove("hidden"),choicesContainerEl.classList.remove("hidden"),loadQuestion())}function loadQuestion(){answerSelected=!1,clearAutoAdvance(autoAdvanceTimeout),currentQuestionIndex<shuffledQuestions.length?(nounDisplayEl.textContent=shuffledQuestions[currentQuestionIndex].noun,translationDisplayEl.textContent=`${shuffledQuestions[currentQuestionIndex].en} / ${shuffledQuestions[currentQuestionIndex].es}`,feedbackAreaEl.classList.add("hidden","correct","incorrect"),feedbackAreaEl.textContent="",hintAreaEl.classList.add("hidden"),enableChoiceButtons(),updateProgress()):showResults()}function enableChoiceButtons(e=!0){artikelButtons.forEach(t=>{t.disabled=!e,t.classList.remove("opacity-50","bg-green-600","bg-red-600","bg-green-400"),t.classList.add(`btn-${t.dataset.artikel}`)})}function handleAnswer(e){if(answerSelected)return;answerSelected=!0;const t=shuffledQuestions[currentQuestionIndex],n=e===t.article;derDieDasUserAnswers.push({question:JSON.parse(JSON.stringify(t)),userAnswer:e,isCorrect:n}),feedbackAreaEl.classList.remove("hidden"),n?(score++,feedbackAreaEl.innerHTML=`Richtig! <span class="correct-answer-text">${t.article} ${t.noun}</span>`,feedbackAreaEl.className="feedback-area correct",triggerConfetti()):(feedbackAreaEl.innerHTML=`Falsch. Richtig ist: <span class="correct-answer-text">${t.article} ${t.noun}</span>`,feedbackAreaEl.className="feedback-area incorrect"),artikelButtons.forEach(s=>{const a=s.dataset.artikel===e,i=s.dataset.artikel===t.article;s.classList.remove("btn-der","btn-die","btn-das","opacity-50"),a?s.classList.add(n?"bg-green-600":"bg-red-600"):i?s.classList.add("bg-green-400"):(s.classList.add("opacity-50"),s.classList.add(`btn-${s.dataset.artikel}`)),s.disabled=!0}),updateProgress(),currentQuestionIndex<shuffledQuestions.length-1?autoAdvanceTimeout=setTimeout(()=>{currentQuestionIndex++,loadQuestion()},2e3):autoAdvanceTimeout=setTimeout(()=>{feedbackAreaEl.classList.add("hidden"),showResults()},2e3)}function updateProgress(){progressIndicatorEl.textContent=`Frage: ${Math.min(currentQuestionIndex+1,shuffledQuestions.length)} / ${shuffledQuestions.length}`,scoreIndicatorEl.textContent=`Punkte: ${score} / ${shuffledQuestions.length}`}function showResults(){clearAutoAdvance(autoAdvanceTimeout),document.getElementById("question-area").classList.add("hidden"),choicesContainerEl.classList.add("hidden"),feedbackAreaEl.classList.remove("hidden"),feedbackAreaEl.className="feedback-area correct",feedbackAreaEl.innerHTML=`Quiz beendet! Endergebnis: <strong class="text-2xl">${score}</strong> / ${shuffledQuestions.length}`,detailedResultsListEl.innerHTML="";let e='<h3 class="text-purple-700">Deine Antworten im Detail:</h3><ul>';derDieDasUserAnswers.forEach(t=>{e+=`<li class="mb-2 p-2 rounded-md ${t.isCorrect?"result-correct":"result-incorrect"}">`,e+=`<strong>${t.question.noun}</strong> (${t.question.en} / ${t.question.es}): `,t.isCorrect?e+=`<span class="text-green-700 font-semibold">Richtig als "${t.userAnswer.toUpperCase()}"</span>`:e+=`<span class="text-red-700">Du: "${t.userAnswer.toUpperCase()}". Richtig:</span> <strong class="text-blue-600">"${t.question.article.toUpperCase()}"</strong>.`,e+="</li>"}),e+="</ul>",detailedResultsListEl.innerHTML=e,detailedResultsListEl.classList.remove("hidden"),progressIndicatorEl.textContent="Quiz beendet!",scoreIndicatorEl.textContent=`Endstand: ${score} / ${shuffledQuestions.length}`,restartQuizBtn.textContent="Quiz neu starten",restartQuizBtn.classList.remove("hidden"),restartQuizBtn.onclick=startQuiz,hintAreaEl.innerHTML="Dr√ºcke <kbd>Leertaste</kbd> zum Neustarten",hintAreaEl.classList.remove("hidden")}

        // --- Speed Mode Functions (no major changes, just uses 'speedQuestions') ---
        function startSpeedRound(){speedQuestions.length>0&&(speedCurrentIndex=0,speedScore=0,speedPaused=!1,speedAnswered=!1,speedCompleteEl.classList.add("hidden"),speedRoundContainer.classList.remove("hidden"),speedPauseBtn.textContent="‚è∏Ô∏è Pause",speedTotalQsEl.textContent=speedQuestions.length,speedFinalTotalEl.textContent=speedQuestions.length,showSpeedQuestion())}function showSpeedQuestion(){if(speedCurrentIndex>=speedQuestions.length)return void completeSpeedRound();speedAnswered=!1;const e=speedQuestions[speedCurrentIndex];speedWordDeEl.textContent=e.noun,speedWordTransEl.textContent=`${e.en} / ${e.es}`,speedProgressEl.textContent=`${speedCurrentIndex+1} / ${speedQuestions.length}`,speedFeedbackEl.classList.add("hidden"),speedChoicesEl.innerHTML="";const t=["der","die","das"],n={der:"btn-der",die:"btn-die",das:"btn-das"};t.forEach(s=>{const a=document.createElement("button");a.className=`btn ${n[s]} text-lg py-4 px-5`,a.textContent=s.toUpperCase(),a.onclick=()=>handleSpeedAnswer(s),speedChoicesEl.appendChild(a)});const s=["linear-gradient(135deg, #667eea 0%, #764ba2 100%)","linear-gradient(135deg, #f093fb 0%, #f5576c 100%)","linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)","linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)","linear-gradient(135deg, #fa709a 0%, #fee140 100%)"];speedRoundContainer.style.background=s[speedCurrentIndex%s.length],startSpeedTimer()}function handleSpeedAnswer(e){if(speedAnswered)return;speedAnswered=!0,clearInterval(speedInterval);const t=speedQuestions[speedCurrentIndex],n=e===t.article;n?(speedScore++,speedFeedbackEl.textContent="‚úÖ Richtig!",speedFeedbackEl.className="text-lg font-bold mb-4 text-green-300"):(speedFeedbackEl.textContent=`‚ùå Falsch! Richtig: ${t.article.toUpperCase()}`,speedFeedbackEl.className="text-lg font-bold mb-4 text-red-300"),speedFeedbackEl.classList.remove("hidden");const s=speedChoicesEl.querySelectorAll("button");s.forEach(s=>{s.disabled=!0;const a=s.textContent.toLowerCase();a===e?s.className=n?"btn bg-green-600 text-lg py-4 px-5":"btn bg-red-600 text-lg py-4 px-5":a===t.article&&!n?s.className="btn bg-green-400 text-lg py-4 px-5":s.className="btn bg-gray-500 text-lg py-4 px-5 opacity-50"}),setTimeout(()=>{speedCurrentIndex++,showSpeedQuestion()},1500)}function startSpeedTimer(){if(speedPaused||speedAnswered)return;clearInterval(speedInterval),timerFillEl.style.transition="none",timerFillEl.style.width="100%",timerFillEl.offsetHeight,timerFillEl.style.transition=`width ${speedTimePerCard/1e3}s linear`,timerFillEl.style.width="0%",speedInterval=setTimeout(()=>{if(speedPaused||speedAnswered)return;speedAnswered=!0;const e=speedQuestions[speedCurrentIndex];speedFeedbackEl.textContent=`‚è∞ Zeit um! Richtig: ${e.article.toUpperCase()}`,speedFeedbackEl.className="text-lg font-bold mb-4 text-orange-300",speedFeedbackEl.classList.remove("hidden"),speedChoicesEl.querySelectorAll("button").forEach(t=>{t.disabled=!0,t.textContent.toLowerCase()===e.article?t.className="btn bg-green-400 text-lg py-4 px-5":t.className="btn bg-gray-500 text-lg py-4 px-5 opacity-50"}),setTimeout(()=>{speedCurrentIndex++,showSpeedQuestion()},1500)},speedTimePerCard)}function toggleSpeedPause(){speedPaused=!speedPaused,speedPauseBtn.textContent=speedPaused?"‚ñ∂Ô∏è Weiter":"‚è∏Ô∏è Pause",speedPaused?(clearInterval(speedInterval),timerFillEl.style.width=getComputedStyle(timerFillEl).width,timerFillEl.style.transition="none"):speedCurrentIndex<speedQuestions.length&&!speedAnswered&&(timerFillEl.style.transition=`width ${parseFloat(timerFillEl.style.width||"0")/timerFillEl.parentNode.offsetWidth*speedTimePerCard/1e3}s linear`,timerFillEl.style.width="0%",clearInterval(speedInterval),speedInterval=setTimeout(()=>{if(speedPaused||speedAnswered)return;speedAnswered=!0;const e=speedQuestions[speedCurrentIndex];speedFeedbackEl.textContent=`‚è∞ Zeit um! Richtig: ${e.article.toUpperCase()}`,speedFeedbackEl.className="text-lg font-bold mb-4 text-orange-300",speedFeedbackEl.classList.remove("hidden"),setTimeout(()=>{speedCurrentIndex++,showSpeedQuestion()},1500)},parseFloat(timerFillEl.style.width||"0")/timerFillEl.parentNode.offsetWidth*speedTimePerCard))}function completeSpeedRound(){clearInterval(speedInterval),speedRoundContainer.classList.add("hidden"),speedCompleteEl.classList.remove("hidden"),speedFinalScoreEl.textContent=speedScore,triggerConfetti()}

        // --- Event Listeners & Initial Load ---
        function handleSpacebar(event) {
            if (event.code !== 'Space' && event.keyCode !== 32) return;
            if (document.activeElement && (document.activeElement.tagName === 'BUTTON' || document.activeElement.tagName === 'INPUT')) {
                const activeId = document.activeElement.id;
                const mainCtrlIds = ['restart-quiz-btn'];
                if (!mainCtrlIds.includes(activeId)) return;
            }
            event.preventDefault();
            if (!quizModeScreen.classList.contains('hidden')) {
                if (!restartQuizBtn.classList.contains('hidden')) { restartQuizBtn.click(); }
            }
        }
        
        async function initialSetup() {
            quizModeBtn.disabled = true;
            speedModeBtn.disabled = true;
            settingsBtn.disabled = true;
            
            const loadingMsg = document.createElement('p');
            loadingMsg.textContent = "Lade Quizdaten...";
            modeSelectionScreen.querySelector('.mode-selection').insertAdjacentElement('beforebegin', loadingMsg);

            loadSettings();
            await loadQuizData();
            
            settingsBtn.disabled = false;
            loadingMsg.remove();
        }

        // --- Event Listeners ---
        quizModeBtn.addEventListener('click', showQuizMode);
        speedModeBtn.addEventListener('click', showSpeedMode);
        backToMenuBtn.addEventListener('click', showModeSelection);
        artikelButtons.forEach(button => button.addEventListener('click', () => handleAnswer(button.dataset.artikel)));
        speedPauseBtn.addEventListener('click', toggleSpeedPause);
        speedRestartBtn.addEventListener('click', startSpeedRound);
        speedBackToMenuBtn.addEventListener('click', showModeSelection);
        speedBackToMenuBtnIngame.addEventListener('click', showModeSelection);
        document.addEventListener('keydown', handleSpacebar);
        settingsBtn.addEventListener('click', openSettings);
        saveSettingsBtn.addEventListener('click', handleSaveSettings);
        numQuestionsSlider.addEventListener('input', (e) => {
            numQuestionsValue.textContent = e.target.value;
        });
        allQuestionsCheckbox.addEventListener('change', (e) => {
            numQuestionsSlider.disabled = e.target.checked;
        });

        // --- App Start ---
        initialSetup();
    </script>
</body>
</html>
